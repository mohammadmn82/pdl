<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileTrackingListener.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.aws</a> &gt; <span class="el_source">FileTrackingListener.java</span></div><h1>FileTrackingListener.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.aws;

import java.io.File;
import java.io.FileNotFoundException;
import java.util.Base64;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.json.Json;
import javax.json.JsonObject;
import javax.naming.ConfigurationException;

import gov.usgs.earthquake.distribution.NotificationEvent;
import gov.usgs.earthquake.distribution.NotificationListener;
import gov.usgs.util.Config;
import gov.usgs.util.DefaultConfigurable;
import gov.usgs.util.FileUtils;
import gov.usgs.util.StreamUtils;

/**
 * This class is a stop-gap to store file-based tracking information in a
 * TrackingIndex.
 *
 * It implements the NotificationListener interface so it can hook into
 * startup/shutdown lifecycle calls used by ProductClient.  Listeners are
 * started before and shutdown after Receivers, and can put a tracking file
 * in place before the receiver starts and save its state after a receiver stops.
 */
public class FileTrackingListener extends DefaultConfigurable implements NotificationListener {

  /** Initialzation of logger. For us later in file. */
<span class="nc" id="L32">  private static final Logger LOGGER = Logger.getLogger(FileTrackingListener.class.getName());</span>

  /** Tracking index property */
  public static final String TRACKING_INDEX_PROPERTY = &quot;trackingIndex&quot;;
  /** Tracking index file property */
  public static final String TRACKING_INDEX_FILE_PROPERTY = &quot;trackingIndexFile&quot;;

  /** Tracking file property */
  public static final String TRACKING_FILE_PROEPRTY = &quot;trackingFile&quot;;

  /** File being tracked. */
  private File trackingFile;
  /** Tracking Index where contents are stored */
  private TrackingIndex trackingIndex;

  /** FileTrackingListener constructor */
<span class="nc" id="L48">  public FileTrackingListener() {</span>
<span class="nc" id="L49">  }</span>

  /** Initializable FileTrackingListener
   * @param trackingFile file to be traacked
   * @param trackingIndex Index where contents are stored
   */
<span class="nc" id="L55">  public FileTrackingListener(final File trackingFile, final TrackingIndex trackingIndex) {</span>
<span class="nc" id="L56">    this.trackingFile = trackingFile;</span>
<span class="nc" id="L57">    this.trackingIndex = trackingIndex;</span>
<span class="nc" id="L58">  }</span>

  /** Getter for trackingFile
   * @return trackingFile
   */
<span class="nc" id="L63">  public File getTrackingFile() { return this.trackingFile; }</span>

  /** Setter for trackingFile
   * @param trackingFile File to be tracked
   */
  public void setTrackingFile(final File trackingFile) {
<span class="nc" id="L69">    this.trackingFile = trackingFile;</span>
<span class="nc" id="L70">  }</span>

  /** Getter for trackingIndex
   * @return trackingIndex
   */
<span class="nc" id="L75">  public TrackingIndex getTrackingIndex() { return this.trackingIndex; }</span>

  /** Setter for trackingIndex
   * @param trackingIndex Index where contents are stored
   */
  public void setTrackingIndex(final TrackingIndex trackingIndex) {
<span class="nc" id="L81">    this.trackingIndex = trackingIndex;</span>
<span class="nc" id="L82">  }</span>

  @Override
  public void configure(Config config) throws Exception {
<span class="nc" id="L86">    super.configure(config);</span>

    // configure tracking index
<span class="nc" id="L89">    final String trackingIndexName = config.getProperty(TRACKING_INDEX_PROPERTY);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    if (trackingIndexName != null) {</span>
<span class="nc" id="L91">      LOGGER.config(&quot;[&quot; + getName() + &quot;] loading tracking index &quot;</span>
          + trackingIndexName);
      try {
        // read object from global config
<span class="nc" id="L95">        trackingIndex = (TrackingIndex) Config.getConfig().getObject(trackingIndexName);</span>
<span class="nc" id="L96">      } catch (Exception e) {</span>
<span class="nc" id="L97">        LOGGER.log(</span>
            Level.WARNING,
<span class="nc" id="L99">            &quot;[&quot; + getName() + &quot;] error loading tracking index &quot;</span>
                + trackingIndexName,
            e);
<span class="nc" id="L102">      }</span>
    } else {
<span class="nc" id="L104">      final String trackingIndexFileName = config.getProperty(TRACKING_INDEX_FILE_PROPERTY);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">      if (trackingIndexFileName != null) {</span>
<span class="nc" id="L106">        LOGGER.config(&quot;[&quot; + getName() + &quot;] creating tracking index at&quot;</span>
            + trackingIndexFileName);
<span class="nc" id="L108">        trackingIndex = new TrackingIndex(</span>
            TrackingIndex.DEFAULT_DRIVER,
            &quot;jdbc:sqlite:&quot; + trackingIndexFileName);
      }
    }

    // configure tracking file
<span class="nc" id="L115">    final String trackingFileName = config.getProperty(TRACKING_FILE_PROEPRTY);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">    if (trackingFileName == null) {</span>
<span class="nc" id="L117">      throw new ConfigurationException(TRACKING_FILE_PROEPRTY + &quot; is required&quot;);</span>
    }
<span class="nc" id="L119">    trackingFile = new File(trackingFileName);</span>
<span class="nc" id="L120">  }</span>

  /**
   * When starting, call loadTrackingFile to create/update file on disk.
   */
  @Override
  public void startup() throws Exception {
<span class="nc" id="L127">    super.startup();</span>
<span class="nc" id="L128">    trackingIndex.startup();</span>
<span class="nc" id="L129">    loadTrackingFile();</span>
<span class="nc" id="L130">  }</span>

  /**
   * When shutting down, call storeTrackingFile to read from file on disk.
   */
  @Override
  public void shutdown() throws Exception {
<span class="nc" id="L137">    storeTrackingFile();</span>
<span class="nc" id="L138">    trackingIndex.shutdown();</span>
<span class="nc" id="L139">    super.shutdown();</span>
<span class="nc" id="L140">  }</span>

  /**
   * Read trackingIndex and write trackingFile.
   *
   * @throws Exception Exception
   */
  public void loadTrackingFile() throws Exception {
<span class="nc" id="L148">    final String name = trackingFile.getAbsolutePath();</span>
<span class="nc" id="L149">    final JsonObject trackingData = trackingIndex.getTrackingData(name);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">    if (trackingData == null) {</span>
<span class="nc" id="L151">      LOGGER.info(&quot;[&quot; + getName() + &quot;] tracking data not found in index, ignoring&quot;);</span>
<span class="nc" id="L152">      return;</span>
    }
<span class="nc" id="L154">    final byte[] data = Base64.getDecoder().decode(trackingData.getString(&quot;data&quot;));</span>
<span class="nc" id="L155">    FileUtils.writeFile(trackingFile, data);</span>
<span class="nc" id="L156">  }</span>

  /**
   * Read trackingFile and write into trackingIndex.
   *
   * @throws Exception Exception
   */
  public void storeTrackingFile() throws Exception {
    try {
      // use absolute path as name
<span class="nc" id="L166">      final String name = trackingFile.getAbsolutePath();</span>
<span class="nc" id="L167">      final byte[] data = StreamUtils.readStream(trackingFile);</span>
<span class="nc" id="L168">      final JsonObject trackingData = Json.createObjectBuilder()</span>
<span class="nc" id="L169">          .add(&quot;name&quot;, name)</span>
<span class="nc" id="L170">          .add(&quot;data&quot;, Base64.getEncoder().encodeToString(data))</span>
<span class="nc" id="L171">          .build();</span>
<span class="nc" id="L172">      trackingIndex.setTrackingData(trackingFile.getAbsolutePath(), trackingData);</span>
<span class="nc" id="L173">    } catch (FileNotFoundException fnf) {</span>
<span class="nc" id="L174">      LOGGER.info(&quot;[&quot; + getName() + &quot;] tracking file not found, ignoring&quot;);</span>
<span class="nc" id="L175">    }</span>
<span class="nc" id="L176">  }</span>

  /**
   * Notification Listener method stubs.
   * These are used only to gain access to lifecycle hooks above.
   */

  @Override
  public void onNotification(NotificationEvent event) throws Exception {
    // ignore
<span class="nc" id="L186">  }</span>

  @Override
  public int getMaxTries() {
<span class="nc" id="L190">    return 1;</span>
  }

  @Override
  public long getTimeout() {
<span class="nc" id="L195">    return 1;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>