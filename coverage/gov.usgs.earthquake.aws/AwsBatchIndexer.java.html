<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AwsBatchIndexer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.aws</a> &gt; <span class="el_source">AwsBatchIndexer.java</span></div><h1>AwsBatchIndexer.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.aws;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.StringReader;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.Date;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.json.Json;
import javax.json.JsonObject;
import javax.json.JsonReader;

import gov.usgs.earthquake.distribution.Bootstrappable;
import gov.usgs.earthquake.indexer.Indexer;
import gov.usgs.earthquake.product.Product;
import gov.usgs.earthquake.product.ProductId;
import gov.usgs.earthquake.util.JDBCConnection;
import gov.usgs.util.Config;
import gov.usgs.util.StreamUtils;
import gov.usgs.util.XmlUtils;

/**
 * Class to index a batch of products that have already been sent to the AWS hub.
 *
 * Reads a list of products to be indexed.
 * Reads indexer from configuration file.
 *
 * For each product, fetch product information from the get_product AWS endpoint
 * and call indexer.onProduct.
 */
<span class="nc" id="L39">public class AwsBatchIndexer implements Bootstrappable {</span>
  /** Force reindex argument */
  public static final String FORCE_REINDEX_ARGUMENT = &quot;--force&quot;;
  /** Get product URL argument */
  public static final String GET_PRODUCT_URL_ARGUMENT = &quot;--getProductUrl=&quot;;
  /** Argument for indexer configuration name */
  public static final String INDEXER_CONFIG_NAME_ARGUMENT=&quot;--indexerConfigName=&quot;;
  /** Default indexer configuration name */
  public static final String INDEXER_CONFIG_NAME_DEFAULT = &quot;indexer&quot;;

  /** Argument for database driver */
  public static final String DATABASE_DRIVER_ARGUMENT = &quot;--databaseDriver=&quot;;
  /** Argument for database URL */
  public static final String DATABASE_URL_ARGUMENT = &quot;--databaseUrl=&quot;;
  /** Argument for indexer database */
  public static final String INDEXER_DATABASE_ARGUMENT = &quot;--indexerDatabase=&quot;;
  /** Default database for indexer */
  public static final String INDEXER_DATABASE_DEFAULT = &quot;indexer&quot;;

  /** Logging object. */
<span class="nc" id="L59">  private static final Logger LOGGER = Logger.getLogger(AwsBatchIndexer.class.getName());</span>

  /** Executor where indexing runs. */
<span class="nc" id="L62">  private ThreadPoolExecutor executor = (ThreadPoolExecutor) Executors.newFixedThreadPool(10);</span>

  /** Whether to force indexing. */
<span class="nc" id="L65">  private boolean force = false;</span>

  /** AWS URL for get_product endpoint, with placeholders. */
<span class="nc" id="L68">  private String getProductUrlTemplate = &quot;https://earthquake.usgs.gov/pdl/west&quot;</span>
      + &quot;/get_product?source={source}&amp;type={type}&amp;code={code}&amp;updateTime={updateTime}&quot;;

  /** Indexer to process products. */
  private Indexer indexer;


  @Override
  public void run(String[] args) throws Exception {
    // parse arguments
<span class="nc" id="L78">    String databaseDriver = &quot;com.mysql.jdbc.Driver&quot;;</span>
<span class="nc" id="L79">    String databaseUrl = null;</span>
<span class="nc" id="L80">    String indexerConfigName = INDEXER_CONFIG_NAME_DEFAULT;</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">    for (final String arg : args) {</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">      if (arg.startsWith(DATABASE_DRIVER_ARGUMENT)) {</span>
<span class="nc" id="L83">        databaseDriver = arg.replace(DATABASE_DRIVER_ARGUMENT, &quot;&quot;);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">      } else if (arg.startsWith(DATABASE_URL_ARGUMENT)) {</span>
<span class="nc" id="L85">        databaseUrl = arg.replace(DATABASE_URL_ARGUMENT, &quot;&quot;);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">      } else if (arg.equals(FORCE_REINDEX_ARGUMENT)) {</span>
<span class="nc" id="L87">        force = true;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">      } else if (arg.startsWith(GET_PRODUCT_URL_ARGUMENT)) {</span>
<span class="nc" id="L89">        getProductUrlTemplate = arg.replace(GET_PRODUCT_URL_ARGUMENT, &quot;&quot;);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">      } else if (arg.startsWith(INDEXER_CONFIG_NAME_ARGUMENT)) {</span>
<span class="nc" id="L91">        indexerConfigName = arg.replace(INDEXER_CONFIG_NAME_ARGUMENT, &quot;&quot;);</span>
      }
    }

    // load indexer from configuration
<span class="nc" id="L96">    indexer = (Indexer) Config.getConfig().getObject(indexerConfigName);</span>
<span class="nc" id="L97">    indexer.startup();</span>

    try {
<span class="nc bnc" id="L100" title="All 2 branches missed.">      if (databaseUrl != null) {</span>
<span class="nc" id="L101">        LOGGER.info(&quot;Reading product ids from database&quot;);</span>
<span class="nc" id="L102">        readProductIdsFromDatabase(databaseDriver, databaseUrl);</span>
      } else {
<span class="nc" id="L104">        LOGGER.info(&quot;Reading product ids from stdin&quot;);</span>
<span class="nc" id="L105">        readProductIdsFromStdin();</span>
      }
    } finally {
<span class="nc" id="L108">      indexer.shutdown();</span>
    }
<span class="nc" id="L110">  }</span>

  /**
   * Use getProductUrl template to generate URL.
   *
   * Replace &quot;{source}&quot;, &quot;{type}&quot;, &quot;{code}&quot;, and &quot;{updateTime}&quot; placeholders.
   *
   * @param id
   *     which product.
   * @return URL with placeholders replaced.
   * @throws Exception Exception
   */
  public URL getProductUrl(final ProductId id) throws Exception {
<span class="nc" id="L123">    String url = getProductUrlTemplate;</span>
<span class="nc" id="L124">    url = url.replace(&quot;{source}&quot;, id.getSource());</span>
<span class="nc" id="L125">    url = url.replace(&quot;{type}&quot;, id.getType());</span>
<span class="nc" id="L126">    url = url.replace(&quot;{code}&quot;, id.getCode());</span>
<span class="nc" id="L127">    url = url.replace(&quot;{updateTime}&quot;, XmlUtils.formatDate(id.getUpdateTime()));</span>
<span class="nc" id="L128">    return new URL(url);</span>
  }

  /**
   * Get Product from endpoint.
   *
   * @param id
   *     which product.
   * @return Product object.
   * @throws Exception Exception
   */
  public Product getProduct(final ProductId id) throws Exception {
<span class="nc" id="L140">    final URL url = getProductUrl(id);</span>
<span class="nc" id="L141">    byte[] bytes = StreamUtils.readStream(url);</span>
    try (
<span class="nc" id="L143">        final JsonReader reader = Json.createReader(new StringReader(</span>
            new String(bytes, StandardCharsets.UTF_8)))
    ) {
      // parse message
<span class="nc" id="L147">      final JsonObject json = reader.readObject();</span>
<span class="nc" id="L148">      final JsonNotification notification = new JsonNotification(json);</span>
<span class="nc" id="L149">      return notification.product;</span>
    }
  }

  /**
   * Fetch and Index a product.
   *
   * Called from executor service to process product ids.
   *
   * @param id
   *     which product
   */
  public void processProductId(final ProductId id) {
<span class="nc" id="L162">    long start = new Date().getTime();</span>
    try {
<span class="nc" id="L164">      final Product product = getProduct(id);</span>
<span class="nc" id="L165">      long afterGetProduct = new Date().getTime();</span>
<span class="nc" id="L166">      LOGGER.fine(&quot;Loaded product &quot; + id.toString() + &quot; in &quot;</span>
          + (afterGetProduct - start) + &quot; ms&quot;);

<span class="nc" id="L169">      indexer.onProduct(product, force);</span>
<span class="nc" id="L170">      LOGGER.info(&quot;Indexed &quot; + id.toString()</span>
<span class="nc" id="L171">          + &quot; in &quot; + (new Date().getTime() - afterGetProduct) + &quot; ms&quot;);</span>
<span class="nc" id="L172">    } catch (Exception e) {</span>
<span class="nc" id="L173">      LOGGER.log(</span>
          Level.WARNING,
<span class="nc" id="L175">          &quot;Error indexing &quot; + id.toString()</span>
<span class="nc" id="L176">              + &quot; in &quot; + (new Date().getTime() - start) + &quot;ms&quot;,</span>
          e);
<span class="nc" id="L178">    }</span>
<span class="nc" id="L179">  }</span>

  /**
   * Read product ids (as urns) from database and submit to executor for processing.
   *
   * @param driver database driver
   * @param url database url
   *
   * @throws Exception exception
   */
  public void readProductIdsFromDatabase(
      final String driver,
      final String url) throws Exception {
    try (
<span class="nc" id="L193">      final JDBCConnection jdbcConnection = new JDBCConnection()</span>
    ) {
<span class="nc" id="L195">      jdbcConnection.setDriver(driver);</span>
<span class="nc" id="L196">      jdbcConnection.setUrl(url);</span>
<span class="nc" id="L197">      jdbcConnection.startup();</span>

<span class="nc" id="L199">      final String sql = &quot;SELECT id, source, type, code, updatetime&quot;</span>
          + &quot; FROM pdl.product h&quot;
          + &quot; WHERE id &gt; ?&quot;
          + &quot; AND NOT EXISTS (&quot;
          + &quot;  SELECT * FROM indexer.productSummary i&quot;
          + &quot;  WHERE h.source=i.source&quot;
          + &quot;  AND h.type=i.type&quot;
          + &quot;  AND h.code=i.code&quot;
          + &quot;  AND h.updatetime=i.updateTime&quot;
          + &quot; )&quot;
          + &quot; ORDER BY id&quot;
          + &quot; LIMIT 500&quot;;

      // start at the beginning
<span class="nc" id="L213">      long lastId = -1;</span>
      while (true) {
<span class="nc" id="L215">        try (</span>
<span class="nc" id="L216">          final Connection conn = jdbcConnection.verifyConnection();</span>
<span class="nc" id="L217">          final PreparedStatement statement = conn.prepareStatement(sql);</span>
        ) {
          // load next batch of products
<span class="nc" id="L220">          statement.setLong(1, lastId);</span>
          try (
<span class="nc" id="L222">            final ResultSet rs = statement.executeQuery();</span>
          ) {
<span class="nc" id="L224">            int count = 0;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L226">              lastId = rs.getLong(&quot;id&quot;);</span>
<span class="nc" id="L227">              final ProductId id = new ProductId(</span>
<span class="nc" id="L228">                  rs.getString(&quot;source&quot;),</span>
<span class="nc" id="L229">                  rs.getString(&quot;type&quot;),</span>
<span class="nc" id="L230">                  rs.getString(&quot;code&quot;),</span>
<span class="nc" id="L231">                  new Date(rs.getLong(&quot;updatetime&quot;)));</span>
<span class="nc" id="L232">              submitProductId(id);</span>
<span class="nc" id="L233">              count++;</span>
<span class="nc" id="L234">            }</span>

            // exit once all products processed
<span class="nc bnc" id="L237" title="All 2 branches missed.">            if (count == 0) {</span>
<span class="nc" id="L238">              LOGGER.info(&quot;No more rows returned, exiting&quot;);</span>
              break;
            }
<span class="nc bnc" id="L241" title="All 2 branches missed.">          }</span>
<span class="nc bnc" id="L242" title="All 4 branches missed.">        }</span>
      }
    }
<span class="nc" id="L245">  }</span>

  /**
   * Read product ids (as urns) from stdin and submit to executor for processing.
   *
   * @throws Exception Exception
   */
  public void readProductIdsFromStdin() throws Exception {
    // read product ids from stdin
<span class="nc" id="L254">    BufferedReader br = new BufferedReader(new InputStreamReader(System.in));</span>
<span class="nc" id="L255">    String line = null;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">    while ((line = br.readLine()) != null) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">      if (line.equals(&quot;&quot;)) {</span>
<span class="nc" id="L258">        continue;</span>
      }
      // parse product id
      final ProductId id;
      try {
<span class="nc" id="L263">        id = ProductId.parse(line);</span>
<span class="nc" id="L264">      } catch (Exception e) {</span>
<span class="nc" id="L265">        LOGGER.warning(&quot;Error parsing product id '&quot; + line + &quot;'&quot;);</span>
<span class="nc" id="L266">        continue;</span>
<span class="nc" id="L267">      }</span>
<span class="nc" id="L268">      submitProductId(id);</span>
<span class="nc" id="L269">    }</span>
<span class="nc" id="L270">  }</span>

  /**
   * Submit a product id to the executor service for processing.
   *
   * If queue is too large (500 ids), blocks until queue is smaller (100 ids).
   *
   * @param id
   *     which product
   * @throws InterruptedException InterruptedException
   */
  public void submitProductId(final ProductId id) throws InterruptedException {
    // queue for processing
<span class="nc" id="L283">    executor.submit(() -&gt; processProductId(id));</span>

    // keep queue size smallish
<span class="nc bnc" id="L286" title="All 2 branches missed.">    if (executor.getQueue().size() &gt; 500) {</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">      while (executor.getQueue().size() &gt; 100) {</span>
<span class="nc" id="L288">        LOGGER.info(&quot;Queue size &quot; + executor.getQueue().size());</span>
<span class="nc" id="L289">        Thread.sleep(5000L);</span>
      }
    }
<span class="nc" id="L292">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>