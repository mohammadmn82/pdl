<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SearchXML.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.indexer</a> &gt; <span class="el_source">SearchXML.java</span></div><h1>SearchXML.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.indexer;

import gov.usgs.earthquake.distribution.FileProductStorage;
import gov.usgs.earthquake.product.Content;
import gov.usgs.earthquake.product.Product;
import gov.usgs.earthquake.product.ProductId;
import gov.usgs.earthquake.product.io.XmlProductHandler;
import gov.usgs.util.XmlUtils;

import java.io.InputStream;
import java.io.OutputStream;
import java.io.OutputStreamWriter;
import java.net.URI;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

/**
 * Formatter for Search XML.
 */
<span class="nc" id="L21">public class SearchXML {</span>

	/** Location of Indexer on distribution site */
	public static final String INDEXER_XMLNS = &quot;http://earthquake.usgs.gov/distribution/indexer&quot;;

	/** Element for searchRequests */
	public static final String REQUEST_ELEMENT = &quot;searchrequest&quot;;
	/** Element for searchResponses */
	public static final String RESPONSE_ELEMENT = &quot;searchresponse&quot;;

	/** Element for results */
	public static final String RESULT_ELEMENT = &quot;result&quot;;
	/** Element for queries */
	public static final String QUERY_ELEMENT = &quot;query&quot;;
	/** Element for events */
	public static final String EVENT_ELEMENT = &quot;event&quot;;
	/** Element for errors */
	public static final String ERROR_ELEMENT = &quot;error&quot;;

	/** Attribute for methods */
	public static final String METHOD_ATTRIBUTE = &quot;method&quot;;

	/** Attribute for event source */
	public static final String EVENT_SOURCE_ATTRIBUTE = &quot;eventSource&quot;;
	/** Attribute for event source code */
	public static final String EVENT_SOURCE_CODE_ATTRIBUTE = &quot;eventSourceCode&quot;;
	/** Attribute for min event time */
	public static final String MIN_EVENT_TIME_ATTRIBUTE = &quot;minEventTime&quot;;
	/** Attribute for max event time */
	public static final String MAX_EVENT_TIME_ATTRIBUTE = &quot;maxEventTime&quot;;
	/** Attribute for min event latitude*/
	public static final String MIN_EVENT_LATITUDE_ATTRIBUTE = &quot;minEventLatitude&quot;;
	/** Attribute for max event latitude */
	public static final String MAX_EVENT_LATITUDE_ATTRIBUTE = &quot;maxEventLatitude&quot;;
	/** Attribute for min event longitude */
	public static final String MIN_EVENT_LONGITUDE_ATTRIBUTE = &quot;minEventLongitude&quot;;
	/** Attribute for max event longitude */
	public static final String MAX_EVENT_LONGITUDE_ATTRIBUTE = &quot;maxEventLongitude&quot;;
	/** Attribute for min event depth */
	public static final String MIN_EVENT_DEPTH_ATTRIBUTE = &quot;minEventDepth&quot;;
	/** Attribute for max event depth*/
	public static final String MAX_EVENT_DEPTH_ATTRIBUTE = &quot;maxEventDepth&quot;;
	/** Attribute for min event magnitude */
	public static final String MIN_EVENT_MAGNITUDE_ATTRIBUTE = &quot;minEventMagnitude&quot;;
	/** Attribute for max event magnitude */
	public static final String MAX_EVENT_MAGNITUDE_ATTRIBUTE = &quot;maxEventMagnitude&quot;;
	/** Attribute for min product update time */
	public static final String MIN_PRODUCT_UPDATE_TIME_ATTRIBUTE = &quot;minProductUpdateTime&quot;;
	/** Attribute for max product update time */
	public static final String MAX_PRODUCT_UPDATE_TIME_ATTRIBUTE = &quot;maxProductUpdateTime&quot;;
	/** Attribute for product source */
	public static final String PRODUCT_SOURCE_ATTRIBUTE = &quot;productSource&quot;;
	/** Attribute for product type */
	public static final String PRODUCT_TYPE_ATTRIBUTE = &quot;productType&quot;;
	/** Attribute for product code */
	public static final String PRODUCT_CODE_ATTRIBUTE = &quot;productCode&quot;;
	/** Attribute for product version */
	public static final String PRODUCT_VERSION_ATTRIBUTE = &quot;productVersion&quot;;
	/** Attribute for product Status */
	public static final String PRODUCT_STATUS_ATTRIBUTE = &quot;productStatus&quot;;

	/** Element for event summary */
	public static final String EVENT_SUMMARY_ELEMENT = &quot;eventSummary&quot;;
	/** Element for product summary */
	public static final String PRODUCT_SUMMARY_ELEMENT = &quot;productSummary&quot;;

	/** Attribute for id */
	public static final String ID_ATTRIBUTE = &quot;id&quot;;
	/** Attribute for update time */
	public static final String UPDATE_TIME_ATTRIBUTE = &quot;updateTime&quot;;
	/** Attribute for status */
	public static final String STATUS_ATTRIBUTE = &quot;status&quot;;
	/** Attribute for source */
	public static final String SOURCE_ATTRIBUTE = &quot;source&quot;;
	/** Attribute for source code */
	public static final String SOURCE_CODE_ATTRIBUTE = &quot;sourceCode&quot;;
	/** Attribute for time */
	public static final String TIME_ATTRIBUTE = &quot;time&quot;;
	/** Attribute for latitude */
	public static final String LATITUDE_ATTRIBUTE = &quot;latitude&quot;;
	/** Attribute for longitude */
	public static final String LONGITUDE_ATTRIBUTE = &quot;longitude&quot;;
	/** Attribute for depth */
	public static final String DEPTH_ATTRIBUTE = &quot;depth&quot;;
	/** Attribute for magnitude */
	public static final String MAGNITUDE_ATTRIBUTE = &quot;magnitude&quot;;
	/** Attribute for version */
	public static final String VERSION_ATTRIBUTE = &quot;version&quot;;
	/** Attribute for preferred weight */
	public static final String PREFERRED_WEIGHT_ATTRIBUTE = &quot;preferredWeight&quot;;

	/**
	 * Parse an input stream with xml to a SearchRequest object.
	 *
	 * @param in
	 *            the input stream containing xml.
	 * @return the parsed SearchRequest object.
	 * @throws Exception if error occurs
	 */
	public static SearchRequest parseRequest(final InputStream in)
			throws Exception {
<span class="fc" id="L122">		SearchRequestParser parser = new SearchRequestParser();</span>
<span class="fc" id="L123">		XmlUtils.parse(in, parser);</span>
<span class="fc" id="L124">		return parser.getSearchRequest();</span>
	}

	/**
	 * Parse an input stream with xml to a SearchResponse object.
	 *
	 * @param in
	 *            the input stream containing xml.
	 * @param storage
	 *            the storage where received products are stored.
	 * @return the parsed SearchResponse object.
	 * @throws Exception if error occurs
	 */
	public static SearchResponse parseResponse(final InputStream in,
			final FileProductStorage storage) throws Exception {
<span class="fc" id="L139">		SearchResponseParser parser = new SearchResponseParser(storage);</span>
<span class="fc" id="L140">		XmlUtils.parse(in, parser);</span>
<span class="fc" id="L141">		return parser.getSearchResponse();</span>
	}

	/**
	 * Convert a SearchRequest object to xml.
	 *
	 * @param request
	 *            the search request object to convert.
	 * @param out
	 *            the output stream where xml is written.
	 * @throws Exception if error occurs
	 */
	public static void toXML(final SearchRequest request, final OutputStream out)
			throws Exception {
<span class="fc" id="L155">		OutputStreamWriter outStream = new OutputStreamWriter(out);</span>
<span class="fc" id="L156">		outStream.write(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;);</span>
<span class="fc" id="L157">		outStream.write(&quot;&lt;&quot; + REQUEST_ELEMENT);</span>
<span class="fc" id="L158">		outStream.write(&quot; xmlns=\&quot;&quot; + INDEXER_XMLNS + &quot;\&quot;&quot;);</span>
<span class="fc" id="L159">		outStream.write(&quot;&gt;&quot;);</span>
<span class="fc" id="L160">		List&lt;SearchQuery&gt; queries = request.getQueries();</span>
<span class="fc" id="L161">		for (Iterator&lt;SearchQuery&gt; queryIterator = queries.iterator(); queryIterator</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L163">			SearchQuery query = queryIterator.next();</span>
<span class="fc" id="L164">			outStream.write(getQueryXMLString(query));</span>
<span class="fc" id="L165">		}</span>
<span class="fc" id="L166">		outStream.write(&quot;&lt;/&quot; + REQUEST_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L167">		outStream.flush();</span>
<span class="fc" id="L168">	}</span>

	/**
	 * Convert a SearchResponse object to xml.
	 *
	 * @param response
	 *            the search response object to convert.
	 * @param out
	 *            the output stream where xml is written.
	 * @throws Exception if error occurs
	 */
	public static void toXML(final SearchResponse response,
			final OutputStream out) throws Exception {
<span class="fc" id="L181">		OutputStreamWriter writer = new OutputStreamWriter(out);</span>
<span class="fc" id="L182">		writer.write(&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;);</span>
<span class="fc" id="L183">		writer.write(&quot;&lt;&quot; + RESPONSE_ELEMENT);</span>
<span class="fc" id="L184">		writer.write(&quot; xmlns=\&quot;&quot; + INDEXER_XMLNS + &quot;\&quot;&quot;);</span>
<span class="fc" id="L185">		writer.write(&quot; xmlns:product=\&quot;&quot;</span>
				+ XmlProductHandler.PRODUCT_XML_NAMESPACE + &quot;\&quot;&quot;);
<span class="fc" id="L187">		writer.write(&quot;&gt;&quot;);</span>
<span class="fc" id="L188">		List&lt;SearchQuery&gt; results = response.getResults();</span>
<span class="fc" id="L189">		for (Iterator&lt;SearchQuery&gt; resultsIterator = results.iterator(); resultsIterator</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L191">			SearchQuery result = resultsIterator.next();</span>
<span class="fc" id="L192">			writer.write(&quot;&lt;&quot; + RESULT_ELEMENT);</span>
<span class="fc" id="L193">			writer.write(&quot; &quot; + METHOD_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L194">					+ result.getType().getXmlMethodName() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L195">			writer.write(&quot;&gt;&quot;);</span>
<span class="fc" id="L196">			writer.write(getQueryXMLString(result));</span>

<span class="fc bfc" id="L198" title="All 2 branches covered.">			if (result.getType() == SearchMethod.EVENT_DETAIL) {</span>
<span class="fc" id="L199">				EventDetailQuery edResult = (EventDetailQuery) result;</span>
<span class="fc" id="L200">				List&lt;Event&gt; events = edResult.getResult();</span>
<span class="fc" id="L201">				for (Iterator&lt;Event&gt; eventIter = events.iterator(); eventIter</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">						.hasNext();) {</span>
<span class="fc" id="L203">					Event event = eventIter.next();</span>
<span class="fc" id="L204">					writer.write(&quot;&lt;&quot; + EVENT_ELEMENT);</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">					if (event.getSource() != null)</span>
<span class="nc" id="L206">						writer.write(&quot; &quot; + SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L207">								+ event.getSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">					if (event.getSourceCode() != null)</span>
<span class="nc" id="L209">						writer.write(&quot; &quot; + SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L210">								+ event.getSourceCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">					if (event.getTime() != null)</span>
<span class="nc" id="L212">						writer.write(&quot; &quot; + TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L213">								+ XmlUtils.formatDate(event.getTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">					if (event.getLatitude() != null)</span>
<span class="nc" id="L215">						writer.write(&quot; &quot; + LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L216">								+ event.getLatitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">					if (event.getLongitude() != null)</span>
<span class="nc" id="L218">						writer.write(&quot; &quot; + LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L219">								+ event.getLongitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">					if (event.getDepth() != null)</span>
<span class="nc" id="L221">						writer.write(&quot; &quot; + DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L222">								+ event.getDepth().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">					if (event.getMagnitude() != null)</span>
<span class="nc" id="L224">						writer.write(&quot; &quot; + MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="nc" id="L225">								+ event.getMagnitude().toString() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L226">					writer.write(&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">					if (!event.getProducts().isEmpty()) {</span>
<span class="fc" id="L228">						Map&lt;String, List&lt;ProductSummary&gt;&gt; products = event</span>
<span class="fc" id="L229">								.getProducts();</span>
<span class="fc" id="L230">						for (Iterator&lt;String&gt; prodIter = products.keySet()</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">								.iterator(); prodIter.hasNext();) {</span>
<span class="fc" id="L232">							String prodType = prodIter.next();</span>
<span class="fc" id="L233">							for (Iterator&lt;ProductSummary&gt; summaryIter = products</span>
<span class="fc" id="L234">									.get(prodType).iterator(); summaryIter</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">									.hasNext();) {</span>
<span class="fc" id="L236">								writer.write(getProductSummaryXmlString(summaryIter</span>
<span class="fc" id="L237">										.next()));</span>
							}
<span class="fc" id="L239">						}</span>
					}
<span class="fc" id="L241">					writer.write(&quot;&lt;/&quot; + EVENT_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L242">				}</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">			} else if (result.getType() == SearchMethod.EVENTS_SUMMARY) {</span>
<span class="fc" id="L244">				EventsSummaryQuery esResult = (EventsSummaryQuery) result;</span>
<span class="fc" id="L245">				List&lt;EventSummary&gt; summaries = esResult.getResult();</span>
<span class="fc" id="L246">				for (Iterator&lt;EventSummary&gt; summaryIter = summaries.iterator(); summaryIter</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">						.hasNext();) {</span>
<span class="fc" id="L248">					writer.write(&quot;&lt;&quot; + EVENT_SUMMARY_ELEMENT);</span>
<span class="fc" id="L249">					EventSummary summary = summaryIter.next();</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">					if (summary.getSource() != null)</span>
<span class="fc" id="L251">						writer.write(&quot; &quot; + SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L252">								+ summary.getSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">					if (summary.getSourceCode() != null)</span>
<span class="fc" id="L254">						writer.write(&quot; &quot; + SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L255">								+ summary.getSourceCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">					if (summary.getTime() != null)</span>
<span class="fc" id="L257">						writer.write(&quot; &quot; + TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L258">								+ XmlUtils.formatDate(summary.getTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">					if (summary.getLatitude() != null)</span>
<span class="fc" id="L260">						writer.write(&quot; &quot; + LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L261">								+ summary.getLatitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">					if (summary.getLongitude() != null)</span>
<span class="fc" id="L263">						writer.write(&quot; &quot; + LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L264">								+ summary.getLongitude().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">					if (summary.getDepth() != null)</span>
<span class="fc" id="L266">						writer.write(&quot; &quot; + DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L267">								+ summary.getDepth().toString() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">					if (summary.getMagnitude() != null)</span>
<span class="fc" id="L269">						writer.write(&quot; &quot; + MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L270">								+ summary.getMagnitude().toString() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L271">					writer.write(&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">					if (!summary.getProperties().isEmpty()) {</span>
<span class="fc" id="L273">						Map&lt;String, String&gt; properties = summary</span>
<span class="fc" id="L274">								.getProperties();</span>
<span class="fc" id="L275">						for (Iterator&lt;String&gt; propIter = properties.keySet()</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">								.iterator(); propIter.hasNext();) {</span>
<span class="fc" id="L277">							String property = propIter.next();</span>
<span class="fc" id="L278">							String value = properties.get(property);</span>
<span class="fc" id="L279">							writer.write(&quot;&lt;product:&quot;</span>
									+ XmlProductHandler.PROPERTY_ELEMENT);
<span class="fc" id="L281">							writer.write(&quot; &quot;</span>
									+ XmlProductHandler.PROPERTY_ATTRIBUTE_NAME
									+ &quot;=\&quot;&quot; + property + &quot;\&quot;&quot;);
<span class="fc" id="L284">							writer.write(&quot; &quot;</span>
									+ XmlProductHandler.PROPERTY_ATTRIBUTE_VALUE
									+ &quot;=\&quot;&quot; + value + &quot;\&quot;&quot;);
<span class="fc" id="L287">							writer.write(&quot; /&gt;&quot;);</span>
<span class="fc" id="L288">						}</span>
					}
<span class="fc" id="L290">					writer.write(&quot;&lt;/&quot; + EVENT_SUMMARY_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L291">				}</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">			} else if (result.getType() == SearchMethod.PRODUCT_DETAIL) {</span>
<span class="fc" id="L293">				ProductDetailQuery pdResult = (ProductDetailQuery) result;</span>
<span class="fc" id="L294">				List&lt;Product&gt; products = pdResult.getResult();</span>
<span class="fc" id="L295">				writer.flush();</span>
<span class="fc" id="L296">				for (Iterator&lt;Product&gt; prodIter = products.iterator(); prodIter</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">						.hasNext();) {</span>
<span class="fc" id="L298">					Product product = prodIter.next();</span>
<span class="fc" id="L299">					XmlProductHandler handler = new XmlProductHandler(out, false);</span>
<span class="fc" id="L300">					handler.onBeginProduct(product.getId(),</span>
<span class="fc" id="L301">							product.getStatus(), product.getTrackerURL());</span>
<span class="fc" id="L302">					Map&lt;String, String&gt; properties = product.getProperties();</span>
<span class="fc" id="L303">					for (Iterator&lt;String&gt; propIter = properties.keySet()</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">							.iterator(); propIter.hasNext();) {</span>
<span class="fc" id="L305">						String name = propIter.next();</span>
<span class="fc" id="L306">						handler.onProperty(product.getId(), name,</span>
<span class="fc" id="L307">								properties.get(name));</span>
<span class="fc" id="L308">					}</span>
<span class="fc" id="L309">					Map&lt;String, List&lt;URI&gt;&gt; links = product.getLinks();</span>
<span class="fc" id="L310">					for (Iterator&lt;String&gt; relIter = links.keySet().iterator(); relIter</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">							.hasNext();) {</span>
<span class="fc" id="L312">						String relation = relIter.next();</span>
<span class="fc" id="L313">						for (Iterator&lt;URI&gt; uriIter = links.get(relation)</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">								.iterator(); uriIter.hasNext();) {</span>
<span class="fc" id="L315">							URI href = uriIter.next();</span>
<span class="fc" id="L316">							handler.onLink(product.getId(), relation, href);</span>
<span class="fc" id="L317">						}</span>
<span class="fc" id="L318">					}</span>
<span class="fc" id="L319">					Map&lt;String, Content&gt; contents = product.getContents();</span>
<span class="fc" id="L320">					for (Iterator&lt;String&gt; pathIter = contents.keySet()</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">							.iterator(); pathIter.hasNext();) {</span>
<span class="fc" id="L322">						String path = pathIter.next();</span>
<span class="fc" id="L323">						handler.onContent(product.getId(), path,</span>
<span class="fc" id="L324">								contents.get(path));</span>
<span class="fc" id="L325">					}</span>
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">					if (product.getSignature() != null)</span>
<span class="fc" id="L327">						handler.onSignature(product.getId(),</span>
<span class="fc" id="L328">								product.getSignature());</span>
<span class="fc" id="L329">					handler.onEndProduct(product.getId());</span>
<span class="fc" id="L330">				}</span>
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">			} else if (result.getType() == SearchMethod.PRODUCTS_SUMMARY) {</span>
<span class="fc" id="L332">				ProductsSummaryQuery psQuery = (ProductsSummaryQuery) result;</span>
<span class="fc" id="L333">				List&lt;ProductSummary&gt; summaries = psQuery.getResult();</span>
<span class="fc" id="L334">				for (Iterator&lt;ProductSummary&gt; summaryIter = summaries</span>
<span class="fc bfc" id="L335" title="All 2 branches covered.">						.iterator(); summaryIter.hasNext();) {</span>
<span class="fc" id="L336">					writer.write(getProductSummaryXmlString(summaryIter.next()));</span>
				}
			}

<span class="fc" id="L340">			writer.write(&quot;&lt;/&quot; + RESULT_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L341">		}</span>
<span class="fc" id="L342">		writer.write(&quot;&lt;/&quot; + RESPONSE_ELEMENT + &quot;&gt;&quot;);</span>
<span class="fc" id="L343">		writer.flush();</span>
<span class="fc" id="L344">	}</span>

	/**
	 * Private  helper method to convert query elements into XML
	 * @param query
	 * 		the query element to convert to xml
	 * @return an xml string representing the query object
	 */
	private static String getQueryXMLString(SearchQuery query) {
<span class="fc" id="L353">		StringBuffer queryXmlString = new StringBuffer();</span>
<span class="fc" id="L354">		queryXmlString.append(&quot;&lt;&quot; + QUERY_ELEMENT);</span>
<span class="fc" id="L355">		queryXmlString.append(&quot; &quot; + METHOD_ATTRIBUTE + &quot;=\&quot;&quot;);</span>
<span class="fc" id="L356">		queryXmlString.append(query.getType().getXmlMethodName());</span>
<span class="fc" id="L357">		queryXmlString.append(&quot;\&quot;&quot;);</span>
<span class="fc" id="L358">		ProductIndexQuery prodIndexQuery = query.getProductIndexQuery();</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">		if (prodIndexQuery.getEventSource() != null)</span>
<span class="fc" id="L360">			queryXmlString.append(&quot; &quot; + EVENT_SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L361">					+ prodIndexQuery.getEventSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">		if (prodIndexQuery.getEventSourceCode() != null)</span>
<span class="fc" id="L363">			queryXmlString.append(&quot; &quot; + EVENT_SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L364">					+ prodIndexQuery.getEventSourceCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventTime() != null)</span>
<span class="fc" id="L366">			queryXmlString.append(&quot; &quot; + MIN_EVENT_TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L367">					+ XmlUtils.formatDate(prodIndexQuery.getMinEventTime())</span>
					+ &quot;\&quot;&quot;);
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventTime() != null)</span>
<span class="fc" id="L370">			queryXmlString.append(&quot; &quot; + MAX_EVENT_TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L371">					+ XmlUtils.formatDate(prodIndexQuery.getMaxEventTime())</span>
					+ &quot;\&quot;&quot;);
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventLatitude() != null)</span>
<span class="fc" id="L374">			queryXmlString.append(&quot; &quot; + MIN_EVENT_LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L375">					+ prodIndexQuery.getMinEventLatitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventLatitude() != null)</span>
<span class="fc" id="L377">			queryXmlString.append(&quot; &quot; + MAX_EVENT_LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L378">					+ prodIndexQuery.getMaxEventLatitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventLongitude() != null)</span>
<span class="fc" id="L380">			queryXmlString.append(&quot; &quot; + MIN_EVENT_LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L381">					+ prodIndexQuery.getMinEventLongitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventLongitude() != null)</span>
<span class="fc" id="L383">			queryXmlString.append(&quot; &quot; + MAX_EVENT_LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L384">					+ prodIndexQuery.getMaxEventLongitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventDepth() != null)</span>
<span class="fc" id="L386">			queryXmlString.append(&quot; &quot; + MIN_EVENT_DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L387">					+ prodIndexQuery.getMinEventDepth() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventDepth() != null)</span>
<span class="fc" id="L389">			queryXmlString.append(&quot; &quot; + MAX_EVENT_DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L390">					+ prodIndexQuery.getMaxEventDepth() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinEventMagnitude() != null)</span>
<span class="fc" id="L392">			queryXmlString.append(&quot; &quot; + MIN_EVENT_MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L393">					+ prodIndexQuery.getMinEventMagnitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxEventMagnitude() != null)</span>
<span class="fc" id="L395">			queryXmlString.append(&quot; &quot; + MAX_EVENT_MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L396">					+ prodIndexQuery.getMaxEventMagnitude() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">		if (prodIndexQuery.getMinProductUpdateTime() != null)</span>
<span class="fc" id="L398">			queryXmlString.append(&quot; &quot;</span>
					+ MIN_PRODUCT_UPDATE_TIME_ATTRIBUTE
					+ &quot;=\&quot;&quot;
<span class="fc" id="L401">					+ XmlUtils.formatDate(prodIndexQuery</span>
<span class="fc" id="L402">							.getMinProductUpdateTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">		if (prodIndexQuery.getMaxProductUpdateTime() != null)</span>
<span class="fc" id="L404">			queryXmlString.append(&quot; &quot;</span>
					+ MAX_PRODUCT_UPDATE_TIME_ATTRIBUTE
					+ &quot;=\&quot;&quot;
<span class="fc" id="L407">					+ XmlUtils.formatDate(prodIndexQuery</span>
<span class="fc" id="L408">							.getMaxProductUpdateTime()) + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductSource() != null)</span>
<span class="fc" id="L410">			queryXmlString.append(&quot; &quot; + PRODUCT_SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L411">					+ prodIndexQuery.getProductSource() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductType() != null)</span>
<span class="fc" id="L413">			queryXmlString.append(&quot; &quot; + PRODUCT_TYPE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L414">					+ prodIndexQuery.getProductType() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductCode() != null)</span>
<span class="fc" id="L416">			queryXmlString.append(&quot; &quot; + PRODUCT_CODE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L417">					+ prodIndexQuery.getProductCode() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductVersion() != null)</span>
<span class="fc" id="L419">			queryXmlString.append(&quot; &quot; + PRODUCT_VERSION_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L420">					+ prodIndexQuery.getProductVersion() + &quot;\&quot;&quot;);</span>
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">		if (prodIndexQuery.getProductStatus() != null)</span>
<span class="fc" id="L422">			queryXmlString.append(&quot; &quot; + PRODUCT_STATUS_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L423">					+ prodIndexQuery.getProductStatus() + &quot;\&quot;&quot;);</span>

<span class="fc" id="L425">		queryXmlString.append(&quot;&gt;&quot;);</span>

<span class="fc" id="L427">		Iterator&lt;ProductId&gt; ids = prodIndexQuery.getProductIds().iterator();</span>
<span class="fc bfc" id="L428" title="All 2 branches covered.">		while (ids.hasNext()) {</span>
<span class="fc" id="L429">			queryXmlString.append(&quot;&lt;&quot; + PRODUCT_SUMMARY_ELEMENT);</span>
<span class="fc" id="L430">			queryXmlString.append(&quot; &quot; + ID_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L431">					+ ids.next().toString() + &quot;\&quot;&quot;);</span>
<span class="fc" id="L432">			queryXmlString.append(&quot; /&gt;&quot;);</span>
		}

<span class="fc" id="L435">		queryXmlString.append(&quot;&lt;/&quot; + QUERY_ELEMENT + &quot;&gt;&quot;);</span>

<span class="fc" id="L437">		return queryXmlString.toString();</span>
	}

	/**
	 * Private  helper method to convert product summary elements into XML
	 * @param summary
	 * 		the product summary element to convert to xml
	 * @return an xml string representing the product summary object
	 */
	private static String getProductSummaryXmlString(ProductSummary summary) {
<span class="fc" id="L447">		String summaryXmlString = &quot;&quot;;</span>
<span class="fc" id="L448">		summaryXmlString += &quot;&lt;&quot; + PRODUCT_SUMMARY_ELEMENT;</span>
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">		if (summary.getId() != null)</span>
<span class="fc" id="L450">			summaryXmlString += &quot; &quot; + ID_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L451">					+ summary.getId().toString() + &quot;\&quot;&quot;;</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">		if (summary.getId().getUpdateTime() != null)</span>
<span class="fc" id="L453">			summaryXmlString += &quot; &quot; + UPDATE_TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L454">					+ XmlUtils.formatDate(summary.getId().getUpdateTime())</span>
					+ &quot;\&quot;&quot;;
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">		if (summary.getStatus() != null)</span>
<span class="fc" id="L457">			summaryXmlString += &quot; &quot; + STATUS_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L458">					+ summary.getStatus() + &quot;\&quot;&quot;;</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">		if (summary.getSource() != null)</span>
<span class="fc" id="L460">			summaryXmlString += &quot; &quot; + SOURCE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L461">					+ summary.getSource() + &quot;\&quot;&quot;;</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">		if (summary.getCode() != null)</span>
<span class="fc" id="L463">			summaryXmlString += &quot; &quot; + SOURCE_CODE_ATTRIBUTE + &quot;=\&quot;&quot; +</span>
<span class="fc" id="L464">					summary.getCode() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L465" title="All 2 branches covered.">		if (summary.getEventTime() != null)</span>
<span class="fc" id="L466">			summaryXmlString += &quot; &quot; + TIME_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L467">					+ XmlUtils.formatDate(summary.getEventTime()) + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L468" title="All 2 branches covered.">		if (summary.getEventLatitude() != null)</span>
<span class="fc" id="L469">			summaryXmlString += &quot; &quot; + LATITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L470">					+ summary.getEventLatitude().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L471" title="All 2 branches covered.">		if (summary.getEventLongitude() != null)</span>
<span class="fc" id="L472">			summaryXmlString += &quot; &quot; + LONGITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L473">					+ summary.getEventLongitude().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">		if (summary.getEventDepth() != null)</span>
<span class="fc" id="L475">			summaryXmlString += &quot; &quot; + DEPTH_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L476">					+ summary.getEventDepth().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L477" title="All 2 branches covered.">		if (summary.getEventMagnitude() != null)</span>
<span class="fc" id="L478">			summaryXmlString += &quot; &quot; + MAGNITUDE_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L479">					+ summary.getEventMagnitude().toString() + &quot;\&quot;&quot;;</span>
<span class="fc bfc" id="L480" title="All 2 branches covered.">		if (summary.getVersion() != null)</span>
<span class="fc" id="L481">			summaryXmlString += &quot; &quot; + VERSION_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L482">					+ summary.getVersion() + &quot;\&quot;&quot;;</span>
<span class="fc" id="L483">		summaryXmlString += &quot; &quot; + PREFERRED_WEIGHT_ATTRIBUTE + &quot;=\&quot;&quot;</span>
<span class="fc" id="L484">				+ summary.getPreferredWeight() + &quot;\&quot;&quot;;</span>
<span class="fc" id="L485">		summaryXmlString += &quot;&gt;&quot;;</span>

<span class="fc" id="L487">		Map&lt;String, String&gt; properties = summary.getProperties();</span>
<span class="fc" id="L488">		for (Iterator&lt;String&gt; propIter = properties.keySet().iterator(); propIter</span>
<span class="fc bfc" id="L489" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L490">			String name = propIter.next();</span>
<span class="fc" id="L491">			String value = properties.get(name);</span>
<span class="fc" id="L492">			summaryXmlString += &quot;&lt;product:&quot;</span>
					+ XmlProductHandler.PROPERTY_ELEMENT;
<span class="fc" id="L494">			summaryXmlString += &quot; &quot; + XmlProductHandler.PROPERTY_ATTRIBUTE_NAME</span>
					+ &quot;=\&quot;&quot; + name + &quot;\&quot;&quot;;
<span class="fc" id="L496">			summaryXmlString += &quot; &quot;</span>
					+ XmlProductHandler.PROPERTY_ATTRIBUTE_VALUE + &quot;=\&quot;&quot;
					+ value + &quot;\&quot;&quot;;
<span class="fc" id="L499">			summaryXmlString += &quot; /&gt;&quot;;</span>
<span class="fc" id="L500">		}</span>

<span class="fc" id="L502">		Map&lt;String, List&lt;URI&gt;&gt; links = summary.getLinks();</span>
<span class="fc" id="L503">		for (Iterator&lt;String&gt; linkIter = links.keySet().iterator(); linkIter</span>
<span class="fc bfc" id="L504" title="All 2 branches covered.">				.hasNext();) {</span>
<span class="fc" id="L505">			String relation = linkIter.next();</span>
<span class="fc" id="L506">			for (Iterator&lt;URI&gt; uriIter = links.get(relation).iterator(); uriIter</span>
<span class="fc bfc" id="L507" title="All 2 branches covered.">					.hasNext();) {</span>
<span class="fc" id="L508">				URI href = uriIter.next();</span>
<span class="fc" id="L509">				summaryXmlString += &quot;&lt;product:&quot;</span>
						+ XmlProductHandler.LINK_ELEMENT;
<span class="fc" id="L511">				summaryXmlString += &quot; &quot;</span>
						+ XmlProductHandler.LINK_ATTRIBUTE_RELATION + &quot;=\&quot;&quot;
						+ relation + &quot;\&quot;&quot;;
<span class="fc" id="L514">				summaryXmlString += &quot; &quot; + XmlProductHandler.LINK_ATTRIBUTE_HREF</span>
						+ &quot;=\&quot;&quot; + href + &quot;\&quot;&quot;;
<span class="fc" id="L516">				summaryXmlString += &quot; /&gt;&quot;;</span>
<span class="fc" id="L517">			}</span>
<span class="fc" id="L518">		}</span>

<span class="fc" id="L520">		summaryXmlString += &quot;&lt;/&quot; + PRODUCT_SUMMARY_ELEMENT + &quot;&gt;&quot;;</span>
<span class="fc" id="L521">		return summaryXmlString;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>