<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CLIProductBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.distribution</a> &gt; <span class="el_source">CLIProductBuilder.java</span></div><h1>CLIProductBuilder.java</h1><pre class="source lang-java linenums">/*
 * CLIProductBuilder
 */
package gov.usgs.earthquake.distribution;

import gov.usgs.earthquake.aws.AwsProductSender;
import gov.usgs.earthquake.product.ByteContent;
import gov.usgs.earthquake.product.FileContent;
import gov.usgs.earthquake.product.InputStreamContent;
import gov.usgs.earthquake.product.Product;
import gov.usgs.earthquake.product.ProductId;
import gov.usgs.util.Config;
import gov.usgs.util.CryptoUtils;
import gov.usgs.util.DefaultConfigurable;
import gov.usgs.util.StreamUtils;
import gov.usgs.util.XmlUtils;
import gov.usgs.util.CryptoUtils.Version;
import gov.usgs.util.StringUtils;

import java.io.File;
import java.math.BigDecimal;
import java.net.URI;
import java.net.URL;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.LinkedList;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Command Line Interface Product Builder.
 *
 * This class is used to build and send products. It is typically called by
 * using the --build argument with the standard ProductClient.
 *
 * The CLIProductBuilder implements the Configurable interface and uses the
 * following configuration parameters:
 *
 * &lt;dl&gt;
 * &lt;dt&gt;senders&lt;/dt&gt;
 * &lt;dd&gt;(Required). A comma separated list of section names that should be loaded
 * as ProductSender objects. Each sender in this list will be used to send any
 * built products. See each type of ProductSender for more configuration
 * details.&lt;/dd&gt;
 * &lt;/dl&gt;
 */
public class CLIProductBuilder extends DefaultConfigurable {

	/** Logging object. */
<span class="fc" id="L54">	private static final Logger LOGGER = Logger</span>
<span class="fc" id="L55">			.getLogger(CLIProductBuilder.class.getName());</span>

	/** Exit code used when an invalid combination of arguments is used. */
	public static final int EXIT_INVALID_ARGUMENTS = 1;

	/** Exit code used when unable to build a product. */
	public static final int EXIT_UNABLE_TO_BUILD = 2;

	/** Exit code used when errors occur while sending. */
	public static final int EXIT_UNABLE_TO_SEND = 3;

	/** Exit code when errors occur while sending, but not to all senders. */
	public static final int EXIT_PARTIALLY_SENT = 4;

	/** product id type argument */
	public static final String TYPE_ARGUMENT = &quot;--type=&quot;;
	/** product id code argument */
	public static final String CODE_ARGUMENT = &quot;--code=&quot;;
	/** product id source argument */
	public static final String SOURCE_ARGUMENT = &quot;--source=&quot;;
	/** product id updateTime argument */
	public static final String UPDATE_TIME_ARGUMENT = &quot;--updateTime=&quot;;

	/** product status argument */
	public static final String STATUS_ARGUMENT = &quot;--status=&quot;;
	/** product delete argument */
	public static final String DELETE_ARGUMENT = &quot;--delete&quot;;

	/** tracker url argument */
	public static final String TRACKER_URL_ARGUMENT = &quot;--trackerURL=&quot;;

  /** property argument */
	public static final String PROPERTY_ARGUMENT = &quot;--property-&quot;;
	/** eventID argument */
	public static final String EVENTID_ARGUMENT = &quot;--eventid=&quot;;
	/** eventsource argument */
	public static final String EVENTSOURCE_ARGUMENT = &quot;--eventsource=&quot;;
	/** eventsourcecode argument */
	public static final String EVENTSOURCECODE_ARGUMENT = &quot;--eventsourcecode=&quot;;
	/** eventCode argument */
	public static final String EVENTCODE_ARGUMENT = &quot;--eventcode=&quot;;
	/** eventtime argument */
	public static final String EVENTTIME_ARGUMENT = &quot;--eventtime=&quot;;
	/** latitude argument */
	public static final String LATITUDE_ARGUMENT = &quot;--latitude=&quot;;
	/** longitude argument */
	public static final String LONGITUDE_ARGUMENT = &quot;--longitude=&quot;;
	/** depth argument */
	public static final String DEPTH_ARGUMENT = &quot;--depth=&quot;;
	/** magnitude argument */
	public static final String MAGNITUDE_ARGUMENT = &quot;--magnitude=&quot;;
	/** version argument */
	public static final String VERSION_ARGUMENT = &quot;--version=&quot;;

	/** product link argument */
	public static final String LINK_ARGUMENT = &quot;--link-&quot;;

	/** product content argument */
	public static final String CONTENT_ARGUMENT = &quot;--content&quot;;
	/** product content type argument */
	public static final String CONTENT_TYPE_ARGUMENT = &quot;--contentType=&quot;;
	/** product directory argument */
	public static final String DIRECTORY_ARGUMENT = &quot;--directory=&quot;;
	/** product file argument */
	public static final String FILE_ARGUMENT = &quot;--file=&quot;;

	/** private key argument */
	public static final String PRIVATE_KEY_ARGUMENT = &quot;--privateKey=&quot;;
	/** signature version argument */
	public static final String SIGNATURE_VERSION_ARGUMENT = &quot;--signatureVersion=&quot;;

	/** Property name used for configuring a tracker url. */
	public static final String TRACKER_URL_CONFIG_PROPERTY = &quot;trackerURL&quot;;

	/** Property name used for configuring the list of senders. */
	public static final String SENDERS_CONFIG_PROPERTY = &quot;senders&quot;;

	/** Arguments for configuring servers and connectTimeouts. */
	public static final String SERVERS_ARGUMENT = &quot;--servers=&quot;;
	/** connectionTimeout argument */
	public static final String CONNECT_TIMEOUT_ARGUMENT = &quot;--connectTimeout=&quot;;
	/** Default connectionTimeout argument. 15s */
<span class="fc" id="L137">	public static final Integer DEFAULT_CONNECT_TIMEOUT = 15000;</span>
	/** binaryFormat argument */
	public static final String BINARY_FORMAT_ARGUMENT = &quot;--binaryFormat&quot;;
	/** disableDeflate argument */
	public static final String DISABLE_DEFLATE = &quot;--disableDeflate&quot;;
	/** disableParallelSend argument */
	public static final String DISABLE_PARALLEL_SEND = &quot;--disableParallelSend&quot;;
	/** parallelSendTimeout argument */
	public static final String PARALLEL_SEND_TIMEOUT_ARGUMENT = &quot;--parallelSendTimeout=&quot;;

	/** Tracker URL that is used when not overriden by an argument. */
	private URL defaultTrackerURL;

	/** ProductSenders that send the product after it is built. */
<span class="fc" id="L151">	private List&lt;ProductSender&gt; senders = new LinkedList&lt;ProductSender&gt;();</span>

	/** The command line arguments being parsed. */
	private String[] args;

<span class="fc" id="L156">	private Integer connectTimeout = DEFAULT_CONNECT_TIMEOUT;</span>
<span class="fc" id="L157">	private boolean parallelSend = Boolean.valueOf(ProductBuilder.DEFAULT_PARALLEL_SEND);</span>
<span class="fc" id="L158">	private long parallelSendTimeout = Long.valueOf(ProductBuilder.DEFAULT_PARALLEL_SEND_TIMEOUT);</span>

	/**
	 * This class is not intended to be instantiated directly.
	 * @param args arguments
	 */
<span class="fc" id="L164">	protected CLIProductBuilder(final String[] args) {</span>
<span class="fc" id="L165">		this.args = args;</span>
<span class="fc" id="L166">	}</span>

	/**
	 * @return the senders
	 */
	public List&lt;ProductSender&gt; getSenders() {
<span class="fc" id="L172">		return senders;</span>
	}

	/**
	 * @return the defaultTrackerURL
	 */
	public URL getDefaultTrackerURL() {
<span class="nc" id="L179">		return defaultTrackerURL;</span>
	}

	/**
	 * @param defaultTrackerURL
	 *            the defaultTrackerURL to set
	 */
	public void setDefaultTrackerURL(URL defaultTrackerURL) {
<span class="nc" id="L187">		this.defaultTrackerURL = defaultTrackerURL;</span>
<span class="nc" id="L188">	}</span>

	/**
	 * Load ProductSenders that will send any built Products.
	 *
	 * There should be a property &quot;senders&quot; containing a comma delimited list of
	 * sender names to be loaded.
	 *
	 * @param config
	 *            the Config to load.
	 */
	public void configure(final Config config) throws Exception {
<span class="nc" id="L200">		Iterator&lt;String&gt; iter = StringUtils.split(</span>
<span class="nc" id="L201">				config.getProperty(SENDERS_CONFIG_PROPERTY), &quot;,&quot;).iterator();</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L203">			String senderName = iter.next();</span>

<span class="nc" id="L205">			LOGGER.config(&quot;Loading sender '&quot; + senderName + &quot;'&quot;);</span>
			// names reference global configuration objects.

<span class="nc" id="L208">			ProductSender sender = (ProductSender) Config.getConfig()</span>
<span class="nc" id="L209">					.getObject(senderName);</span>

<span class="nc bnc" id="L211" title="All 2 branches missed.">			if (sender == null) {</span>
<span class="nc" id="L212">				throw new ConfigurationException(&quot;Sender '&quot; + senderName</span>
						+ &quot;' is not properly configured&quot;);
			}

<span class="nc" id="L216">			senders.add(sender);</span>
<span class="nc" id="L217">		}</span>

<span class="nc" id="L219">		String trackerURLProperty = config</span>
<span class="nc" id="L220">				.getProperty(TRACKER_URL_CONFIG_PROPERTY);</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">		if (trackerURLProperty != null) {</span>
<span class="nc" id="L222">			defaultTrackerURL = new URL(trackerURLProperty);</span>
		}

<span class="nc" id="L225">		parallelSend = Boolean.valueOf(config.getProperty(</span>
				ProductBuilder.PARALLEL_SEND_PROPERTY,
				ProductBuilder.DEFAULT_PARALLEL_SEND));
<span class="nc" id="L228">		parallelSendTimeout = Long.valueOf(config.getProperty(</span>
				ProductBuilder.PARALLEL_SEND_TIMEOUT_PROPERTY,
				ProductBuilder.DEFAULT_PARALLEL_SEND_TIMEOUT));
<span class="nc" id="L231">		LOGGER.config(&quot;[&quot; + getName() + &quot;] parallel send enabled=&quot;</span>
				+ parallelSend + &quot;, timeout=&quot; + parallelSendTimeout);
<span class="nc" id="L233">	}</span>

	/**
	 * Called when the client is shutting down.
	 */
	public void shutdown() throws Exception {
<span class="nc" id="L239">		Iterator&lt;ProductSender&gt; iter = senders.iterator();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
			try {
<span class="nc" id="L242">				iter.next().shutdown();</span>
<span class="nc" id="L243">			} catch (Exception e) {</span>
<span class="nc" id="L244">				LOGGER.log(Level.WARNING, &quot;Exception shutting down sender&quot;, e);</span>
<span class="nc" id="L245">			}</span>
		}
<span class="nc" id="L247">	}</span>

	/**
	 * Called when the client is done configuring.
	 */
	public void startup() throws Exception {
<span class="nc" id="L253">		Iterator&lt;ProductSender&gt; iter = senders.iterator();</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L255">			iter.next().startup();</span>
		}
<span class="nc" id="L257">	}</span>

	/**
	 * Send a product to all configured ProductSenders.
	 *
	 * @param product
	 *            the product to send.
	 * @return exceptions that occured while sending. If map is empty, there
	 *         were no exceptions.
	 */
	public Map&lt;ProductSender, Exception&gt; sendProduct(final Product product) {
<span class="fc" id="L268">		Map&lt;ProductSender, Exception&gt; sendExceptions = new HashMap&lt;ProductSender, Exception&gt;();</span>

<span class="fc" id="L270">		Iterator&lt;ProductSender&gt; iter = senders.iterator();</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">		while (iter.hasNext()) {</span>
<span class="fc" id="L272">			ProductSender sender = iter.next();</span>
			try {
<span class="fc" id="L274">				sender.sendProduct(product);</span>
<span class="nc" id="L275">			} catch (Exception e) {</span>
<span class="nc" id="L276">				sendExceptions.put(sender, e);</span>
<span class="fc" id="L277">			}</span>
<span class="fc" id="L278">		}</span>

<span class="fc" id="L280">		return sendExceptions;</span>
	}

	/**
	 * Build a product using command line arguments.
	 *
	 * @return Product
	 * @throws Exception if error occurs
	 */
	public Product buildProduct() throws Exception {
		// start product id with null values, and verify they are all set after
		// all arguments are parsed.
<span class="fc" id="L292">		Product product = new Product(new ProductId(null, null, null));</span>
<span class="fc" id="L293">		product.setTrackerURL(defaultTrackerURL);</span>

		// These things are also processed after all arguments are parsed.
		// used with inline content
<span class="fc" id="L297">		boolean hasStdinContent = false;</span>
<span class="fc" id="L298">		String contentType = null;</span>
		// used when signing products
<span class="fc" id="L300">		File privateKey = null;</span>
<span class="fc" id="L301">		Version signatureVersion = Version.SIGNATURE_V1;</span>
<span class="fc" id="L302">		boolean binaryFormat = false;</span>
<span class="fc" id="L303">		boolean enableDeflate = true;</span>

<span class="fc bfc" id="L305" title="All 2 branches covered.">		for (String arg : args) {</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">			if (arg.startsWith(TYPE_ARGUMENT)) {</span>
<span class="fc" id="L307">				product.getId().setType(arg.replace(TYPE_ARGUMENT, &quot;&quot;));</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">			} else if (arg.startsWith(CODE_ARGUMENT)) {</span>
<span class="fc" id="L309">				product.getId().setCode(arg.replace(CODE_ARGUMENT, &quot;&quot;));</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">			} else if (arg.startsWith(SOURCE_ARGUMENT)) {</span>
<span class="fc" id="L311">				product.getId().setSource(arg.replace(SOURCE_ARGUMENT, &quot;&quot;));</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">			} else if (arg.startsWith(UPDATE_TIME_ARGUMENT)) {</span>
<span class="nc" id="L313">				product.getId()</span>
<span class="nc" id="L314">						.setUpdateTime(</span>
<span class="nc" id="L315">								XmlUtils.getDate(arg.replace(</span>
										UPDATE_TIME_ARGUMENT, &quot;&quot;)));
<span class="fc bfc" id="L317" title="All 2 branches covered.">			} else if (arg.startsWith(STATUS_ARGUMENT)) {</span>
<span class="fc" id="L318">				product.setStatus(arg.replace(STATUS_ARGUMENT, &quot;&quot;));</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">			} else if (arg.equals(DELETE_ARGUMENT)) {</span>
<span class="fc" id="L320">				product.setStatus(Product.STATUS_DELETE);</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">			} else if (arg.startsWith(TRACKER_URL_ARGUMENT)) {</span>
<span class="fc" id="L322">				product.setTrackerURL(new URL(arg.replace(TRACKER_URL_ARGUMENT,</span>
						&quot;&quot;)));
<span class="fc bfc" id="L324" title="All 2 branches covered.">			} else if (arg.startsWith(PROPERTY_ARGUMENT)) {</span>
<span class="fc" id="L325">				String[] props = arg.replace(PROPERTY_ARGUMENT, &quot;&quot;).split(&quot;=&quot;,</span>
						2);
				try {
<span class="fc" id="L328">					product.getProperties().put(props[0], props[1]);</span>
<span class="nc" id="L329">				} catch (IndexOutOfBoundsException ioobe) {</span>
<span class="nc" id="L330">					throw new IllegalArgumentException(</span>
							&quot;Invalid property argument, must have value&quot;);
<span class="fc" id="L332">				}</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">			} else if (arg.startsWith(EVENTID_ARGUMENT)) {</span>
<span class="nc" id="L334">				String id = arg.replace(EVENTID_ARGUMENT, &quot;&quot;).toLowerCase();</span>
<span class="nc" id="L335">				String eventNetwork = id.substring(0, 2);</span>
<span class="nc" id="L336">				String eventNetworkId = id.substring(2);</span>
<span class="nc" id="L337">				product.setEventId(eventNetwork, eventNetworkId);</span>
<span class="pc bpc" id="L338" title="1 of 2 branches missed.">			} else if (arg.startsWith(EVENTSOURCE_ARGUMENT)) {</span>
<span class="nc" id="L339">				product.setEventSource(arg.replace(EVENTSOURCE_ARGUMENT, &quot;&quot;)</span>
<span class="nc" id="L340">						.toLowerCase());</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">			} else if (arg.startsWith(EVENTSOURCECODE_ARGUMENT)) {</span>
<span class="nc" id="L342">				product.setEventSourceCode(arg.replace(</span>
<span class="nc" id="L343">						EVENTSOURCECODE_ARGUMENT, &quot;&quot;).toLowerCase());</span>
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">			} else if (arg.startsWith(EVENTCODE_ARGUMENT)) {</span>
<span class="nc" id="L345">				product.setEventSourceCode(arg.replace(EVENTCODE_ARGUMENT, &quot;&quot;)</span>
<span class="nc" id="L346">						.toLowerCase());</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">			} else if (arg.startsWith(EVENTTIME_ARGUMENT)) {</span>
<span class="nc" id="L348">				product.setEventTime(XmlUtils.getDate(arg.replace(</span>
						EVENTTIME_ARGUMENT, &quot;&quot;)));
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">			} else if (arg.startsWith(MAGNITUDE_ARGUMENT)) {</span>
<span class="nc" id="L351">				product.setMagnitude(new BigDecimal(arg.replace(</span>
						MAGNITUDE_ARGUMENT, &quot;&quot;)));
<span class="fc bfc" id="L353" title="All 2 branches covered.">			} else if (arg.startsWith(LATITUDE_ARGUMENT)) {</span>
<span class="fc" id="L354">				product.setLatitude(new BigDecimal(arg.replace(</span>
						LATITUDE_ARGUMENT, &quot;&quot;)));
<span class="fc bfc" id="L356" title="All 2 branches covered.">			} else if (arg.startsWith(LONGITUDE_ARGUMENT)) {</span>
<span class="fc" id="L357">				product.setLongitude(new BigDecimal(arg.replace(</span>
						LONGITUDE_ARGUMENT, &quot;&quot;)));
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">			} else if (arg.startsWith(DEPTH_ARGUMENT)) {</span>
<span class="nc" id="L360">				product.setDepth(new BigDecimal(arg.replace(DEPTH_ARGUMENT, &quot;&quot;)));</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">			} else if (arg.startsWith(VERSION_ARGUMENT)) {</span>
<span class="nc" id="L362">				product.setVersion(arg.replace(VERSION_ARGUMENT, &quot;&quot;));</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">			} else if (arg.startsWith(LINK_ARGUMENT)) {</span>
<span class="fc" id="L364">				String[] props = arg.replace(LINK_ARGUMENT, &quot;&quot;).split(&quot;=&quot;, 2);</span>
				try {
<span class="fc" id="L366">					product.addLink(props[0], new URI(props[1]));</span>
<span class="nc" id="L367">				} catch (IndexOutOfBoundsException ioobe) {</span>
<span class="nc" id="L368">					throw new IllegalArgumentException(</span>
							&quot;Invalid link, must have URL as value&quot;);
<span class="fc" id="L370">				}</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">			} else if (arg.equals(CONTENT_ARGUMENT)) {</span>
<span class="fc" id="L372">				hasStdinContent = true;</span>
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">			} else if (arg.startsWith(CONTENT_TYPE_ARGUMENT)) {</span>
<span class="fc" id="L374">				contentType = arg.replace(CONTENT_TYPE_ARGUMENT, &quot;&quot;);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">			} else if (arg.startsWith(DIRECTORY_ARGUMENT)) {</span>
<span class="nc" id="L376">				product.getContents().putAll(</span>
<span class="nc" id="L377">						FileContent.getDirectoryContents(new File(arg.replace(</span>
								DIRECTORY_ARGUMENT, &quot;&quot;))));
<span class="nc bnc" id="L379" title="All 2 branches missed.">			} else if (arg.startsWith(FILE_ARGUMENT)) {</span>
<span class="nc" id="L380">				File file = new File(arg.replace(FILE_ARGUMENT, &quot;&quot;));</span>
<span class="nc" id="L381">				product.getContents()</span>
<span class="nc" id="L382">						.put(file.getName(), new FileContent(file));</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">			} else if (arg.startsWith(PRIVATE_KEY_ARGUMENT)) {</span>
<span class="nc" id="L384">				privateKey = new File(arg.replace(PRIVATE_KEY_ARGUMENT, &quot;&quot;));</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">			} else if (arg.startsWith(SIGNATURE_VERSION_ARGUMENT)) {</span>
<span class="nc" id="L386">				signatureVersion = Version.fromString(</span>
<span class="nc" id="L387">						arg.replace(SIGNATURE_VERSION_ARGUMENT, &quot;&quot;));</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">			} else if (arg.startsWith(SERVERS_ARGUMENT)) {</span>
<span class="nc" id="L389">				senders.clear();</span>
<span class="nc" id="L390">				senders.addAll(parseServers(arg.replace(SERVERS_ARGUMENT, &quot;&quot;),</span>
						connectTimeout, binaryFormat, enableDeflate));
<span class="nc bnc" id="L392" title="All 2 branches missed.">			} else if (arg.startsWith(CONNECT_TIMEOUT_ARGUMENT)) {</span>
<span class="nc" id="L393">				connectTimeout = Integer.valueOf(arg.replace(</span>
						CONNECT_TIMEOUT_ARGUMENT, &quot;&quot;));
<span class="nc bnc" id="L395" title="All 2 branches missed.">			} else if (arg.equals(BINARY_FORMAT_ARGUMENT)) {</span>
<span class="nc" id="L396">				binaryFormat = true;</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">			} else if (arg.equals(DISABLE_DEFLATE)) {</span>
<span class="nc" id="L398">				enableDeflate = false;</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">			} else if (arg.equals(DISABLE_PARALLEL_SEND)) {</span>
<span class="nc" id="L400">				parallelSend = false;</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">			} else if (arg.startsWith(PARALLEL_SEND_TIMEOUT_ARGUMENT)) {</span>
<span class="nc" id="L402">				parallelSendTimeout = Long.valueOf(</span>
<span class="nc" id="L403">						arg.replace(PARALLEL_SEND_TIMEOUT_ARGUMENT, &quot;&quot;));</span>
			} else {
				// not a builder argument
			}
		}

		// validate product
<span class="fc" id="L410">		ProductId id = product.getId();</span>
<span class="pc bpc" id="L411" title="1 of 4 branches missed.">		if (id.getType() == null || id.getSource() == null</span>
<span class="pc bpc" id="L412" title="2 of 4 branches missed.">				|| id.getCode() == null || id.getUpdateTime() == null) {</span>
<span class="fc" id="L413">			throw new IllegalArgumentException(&quot;Incomplete ProductId: source=&quot;</span>
<span class="fc" id="L414">					+ id.getSource() + &quot;, type=&quot; + id.getType() + &quot;, code=&quot;</span>
<span class="fc" id="L415">					+ id.getCode() + &quot;, updateTime=&quot; + id.getUpdateTime());</span>
		}

		// tracker url is required
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">		if (product.getTrackerURL() == null) {</span>
<span class="nc" id="L420">			throw new IllegalArgumentException(&quot;Tracker URL is required&quot;);</span>
		}

<span class="pc bpc" id="L423" title="1 of 2 branches missed.">		if (hasStdinContent) {</span>
<span class="fc" id="L424">			LOGGER.info(&quot;Reading content on standard input&quot;);</span>

<span class="fc" id="L426">			ByteContent stdinContent = new ByteContent(new InputStreamContent(</span>
					System.in));
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">			if (contentType != null) {</span>
<span class="fc" id="L429">				stdinContent.setContentType(contentType);</span>
			}
<span class="fc" id="L431">			product.getContents().put(&quot;&quot;, stdinContent);</span>
		}

		// products that aren't being deleted should have content
<span class="pc bpc" id="L435" title="3 of 4 branches missed.">		if (product.getContents().size() == 0 &amp;&amp; !product.isDeleted()) {</span>
<span class="nc" id="L436">			LOGGER.warning(&quot;Product has no content, are you sure this is intended?&quot;);</span>
		}

		// mark which version of client was used to create product
<span class="fc" id="L440">		product.getProperties().put(ProductClient.PDL_CLIENT_VERSION_PROPERTY,</span>
				ProductClient.RELEASE_VERSION);

<span class="pc bpc" id="L443" title="1 of 2 branches missed.">		if (privateKey != null) {</span>
<span class="nc" id="L444">			LOGGER.fine(&quot;Signing product&quot;);</span>
<span class="nc" id="L445">			product.sign(</span>
<span class="nc" id="L446">					CryptoUtils.readOpenSSHPrivateKey(</span>
<span class="nc" id="L447">							StreamUtils.readStream(StreamUtils.getInputStream(privateKey)),</span>
							null),
					signatureVersion);
		}

<span class="fc" id="L452">		return product;</span>
	}

	/**
	 * Parse servers for list of product senders
	 * @param servers CSV string of servers
	 * @param connectTimeout timeout
	 * @param binaryFormat if binaryFormat
	 * @param enableDeflate if enableDeflate
	 * @return List of product senders
	 * */
	public static List&lt;ProductSender&gt; parseServers(final String servers,
			final Integer connectTimeout, final boolean binaryFormat,
			final boolean enableDeflate) throws Exception {
<span class="nc" id="L466">		List&lt;ProductSender&gt; senders = new ArrayList&lt;ProductSender&gt;();</span>

<span class="nc" id="L468">		Iterator&lt;String&gt; iter = StringUtils.split(servers, &quot;,&quot;).iterator();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L470">			String server = iter.next();</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">			if (server.startsWith(&quot;https://&quot;)) {</span>
<span class="nc" id="L472">				AwsProductSender sender = new AwsProductSender(new URL(server));</span>
<span class="nc" id="L473">				senders.add(sender);</span>
<span class="nc" id="L474">			} else {</span>
<span class="nc" id="L475">				String[] parts = server.split(&quot;:&quot;);</span>
<span class="nc" id="L476">				SocketProductSender sender = new SocketProductSender(parts[0],</span>
<span class="nc" id="L477">						Integer.parseInt(parts[1]), connectTimeout);</span>
<span class="nc" id="L478">				sender.setBinaryFormat(binaryFormat);</span>
<span class="nc" id="L479">				sender.setEnableDeflate(enableDeflate);</span>
<span class="nc" id="L480">				senders.add(sender);</span>
			}
<span class="nc" id="L482">		}</span>

<span class="nc" id="L484">		return senders;</span>
	}

	/**
	 * Entry point into CLIProductBuilder.
	 *
	 * Called by Main if the --build argument is present.
	 *
	 * @param args arguments
	 * @throws Exception if error occurs
	 */
	public static void main(final String[] args) throws Exception {
<span class="nc" id="L496">		CLIProductBuilder builder = new CLIProductBuilder(args);</span>
<span class="nc" id="L497">		builder.configure(Config.getConfig());</span>
<span class="nc" id="L498">		builder.startup();</span>

<span class="nc" id="L500">		Product product = null;</span>
		try {
<span class="nc" id="L502">			product = builder.buildProduct();</span>
<span class="nc" id="L503">		} catch (Exception e) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">			if (e.getMessage() == null) {</span>
<span class="nc" id="L505">				LOGGER.log(Level.SEVERE, &quot;Error building product&quot;, e);</span>
			} else {
<span class="nc" id="L507">				LOGGER.severe(&quot;Invalid arguments: &quot; + e.getMessage());</span>
			}
<span class="nc" id="L509">			System.exit(EXIT_INVALID_ARGUMENTS);</span>
<span class="nc" id="L510">		}</span>

<span class="nc bnc" id="L512" title="All 2 branches missed.">		if (product == null) {</span>
<span class="nc" id="L513">			LOGGER.severe(&quot;Unable to build product&quot;);</span>
<span class="nc" id="L514">			System.exit(EXIT_UNABLE_TO_BUILD);</span>
		}

		// send tracker update
<span class="nc" id="L518">		new ProductTracker(product.getTrackerURL()).productCreated(</span>
<span class="nc" id="L519">				SocketProductSender.class.getName(), product.getId());</span>

		// send the product
<span class="nc bnc" id="L522" title="All 2 branches missed.">		Map&lt;ProductSender, Exception&gt; sendExceptions = builder.parallelSend</span>
<span class="nc" id="L523">				? ProductBuilder.parallelSendProduct(</span>
							builder.senders,
							product,
							builder.parallelSendTimeout)
<span class="nc" id="L527">				: builder.sendProduct(product);</span>

		// handle any send exceptions
<span class="nc bnc" id="L530" title="All 2 branches missed.">		if (sendExceptions.size() != 0) {</span>
<span class="nc" id="L531">			Iterator&lt;ProductSender&gt; senders = sendExceptions.keySet()</span>
<span class="nc" id="L532">					.iterator();</span>
			// log the exceptions
<span class="nc bnc" id="L534" title="All 2 branches missed.">			while (senders.hasNext()) {</span>
<span class="nc" id="L535">				ProductSender sender = senders.next();</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">				if (sender instanceof SocketProductSender) {</span>
					// put more specific information about socket senders
<span class="nc" id="L538">					SocketProductSender socketSender = (SocketProductSender) sender;</span>
<span class="nc" id="L539">					LOGGER.log(</span>
							Level.WARNING,
							&quot;Exception sending product to &quot;
<span class="nc" id="L542">									+ socketSender.getHost() + &quot;:&quot;</span>
<span class="nc" id="L543">									+ socketSender.getPort(),</span>
<span class="nc" id="L544">							sendExceptions.get(sender));</span>
<span class="nc" id="L545">				} else {</span>
<span class="nc" id="L546">					LOGGER.log(Level.WARNING, &quot;Exception sending product &quot;</span>
<span class="nc" id="L547">							+ sendExceptions.get(sender));</span>
				}
<span class="nc" id="L549">			}</span>

<span class="nc bnc" id="L551" title="All 2 branches missed.">			if (sendExceptions.size() &lt; builder.getSenders().size()) {</span>
<span class="nc" id="L552">				LOGGER.warning(&quot;Partial failure sending product,&quot;</span>
						+ &quot; at least one sender accepted product.&quot;
						+ &quot; Check the tracker for more information.&quot;);
				// still output built product id
<span class="nc" id="L556">				System.out.println(product.getId().toString());</span>
				// but exit with partial failure
<span class="nc" id="L558">				System.exit(EXIT_PARTIALLY_SENT);</span>
			} else {
<span class="nc" id="L560">				LOGGER.severe(&quot;Total failure sending product&quot;);</span>
<span class="nc" id="L561">				System.exit(EXIT_UNABLE_TO_SEND);</span>
			}

		}

		// otherwise output built product id
<span class="nc" id="L567">		System.out.println(product.getId().toString());</span>

		// normal exit
<span class="nc" id="L570">		builder.shutdown();</span>
<span class="nc" id="L571">		System.exit(0);</span>
<span class="nc" id="L572">	}</span>
	/**
	 * Function on how to use command
	 * @return string
	 */
	public static String getUsage() {
<span class="nc" id="L578">		StringBuffer buf = new StringBuffer();</span>

<span class="nc" id="L580">		buf.append(&quot;Product identification\n&quot;);</span>
<span class="nc" id="L581">		buf.append(&quot;--source=SOURCE          product source, e.g. us, nc\n&quot;);</span>
<span class="nc" id="L582">		buf.append(&quot;--type=TYPE              product type, e.g. shakemap, pager\n&quot;);</span>
<span class="nc" id="L583">		buf.append(&quot;--code=CODE              product code, e.g. us2009abcd, nc12345678\n&quot;);</span>
<span class="nc" id="L584">		buf.append(&quot;[--updateTime=TIME]      when the product was updated\n&quot;);</span>
<span class="nc" id="L585">		buf.append(&quot;                         e.g. 2010-02-11T15:16:17+0000\n&quot;);</span>
<span class="nc" id="L586">		buf.append(&quot;                         default is now\n&quot;);</span>
<span class="nc" id="L587">		buf.append(&quot;[--status=STATUS]        product status\n&quot;);</span>
<span class="nc" id="L588">		buf.append(&quot;                         default is UPDATE\n&quot;);</span>
<span class="nc" id="L589">		buf.append(&quot;[--delete]               same as --status=DELETE\n&quot;);</span>
<span class="nc" id="L590">		buf.append(&quot;\n&quot;);</span>

<span class="nc" id="L592">		buf.append(&quot;Product contents\n&quot;);</span>
<span class="nc" id="L593">		buf.append(&quot;[--directory=DIR]        read content from a directory, preserves hierarchy\n&quot;);</span>
<span class="nc" id="L594">		buf.append(&quot;[--file=FILE]            read content from a file, added at top level of product\n&quot;);</span>
<span class="nc" id="L595">		buf.append(&quot;[--content]              read content from STDIN\n&quot;);</span>
<span class="nc" id="L596">		buf.append(&quot;[--contentType=MIMETYPE] used with --content to specify STDIN mime type\n&quot;);</span>
<span class="nc" id="L597">		buf.append(&quot;\n&quot;);</span>

<span class="nc" id="L599">		buf.append(&quot;Product metadata\n&quot;);</span>
<span class="nc" id="L600">		buf.append(&quot;[--link-RELATION=URI]    link to another product or resource\n&quot;);</span>
<span class="nc" id="L601">		buf.append(&quot;[--property-NAME=VALUE]  attributes of this product\n&quot;);</span>
<span class="nc" id="L602">		buf.append(&quot;[--latitude=LAT]         Latitude of associated event.\n&quot;);</span>
<span class="nc" id="L603">		buf.append(&quot;                             Decimal degrees\n&quot;);</span>
<span class="nc" id="L604">		buf.append(&quot;                             Same as --property-latitude=LAT\n&quot;);</span>
<span class="nc" id="L605">		buf.append(&quot;[--longitude=LNG]        Longitude of associated event.\n&quot;);</span>
<span class="nc" id="L606">		buf.append(&quot;                             Decimal degrees\n&quot;);</span>
<span class="nc" id="L607">		buf.append(&quot;                             Same as --property-longitude=LNG\n&quot;);</span>
<span class="nc" id="L608">		buf.append(&quot;[--eventtime=TIME]       Time of associated event.\n&quot;);</span>
<span class="nc" id="L609">		buf.append(&quot;                             Example: 2010-02-11T15:16:17+0000\n&quot;);</span>
<span class="nc" id="L610">		buf.append(&quot;                             Same as --property-eventtime=TIME\n&quot;);</span>
<span class="nc" id="L611">		buf.append(&quot;[--magnitude=MAG]        Magnitude of associated event.\n&quot;);</span>
<span class="nc" id="L612">		buf.append(&quot;                             Same as --property-magnitude=MAG\n&quot;);</span>
<span class="nc" id="L613">		buf.append(&quot;[--depth=DEPTH]          Depth of associated event.\n&quot;);</span>
<span class="nc" id="L614">		buf.append(&quot;                             Kilometers.\n&quot;);</span>
<span class="nc" id="L615">		buf.append(&quot;                             Same as --property-depth=DEPTH\n&quot;);</span>
<span class="nc" id="L616">		buf.append(&quot;[--eventsource=SOURCE]   Network of associated event.\n&quot;);</span>
<span class="nc" id="L617">		buf.append(&quot;                             Examples: us, nc, ci\n&quot;);</span>
<span class="nc" id="L618">		buf.append(&quot;                             Same as --property-eventsource=SOURCE\n&quot;);</span>
<span class="nc" id="L619">		buf.append(&quot;[--eventcode=CODE]       NetworkID of associated event.\n&quot;);</span>
<span class="nc" id="L620">		buf.append(&quot;                             Examples: 2010abcd, 12345678\n&quot;);</span>
<span class="nc" id="L621">		buf.append(&quot;                             Same as --property-eventsourcecode=CODE\n&quot;);</span>
<span class="nc" id="L622">		buf.append(&quot;[--eventid=EVENTID]      Deprecated, use --eventsource and --eventsourcecode.\n&quot;);</span>
<span class="nc" id="L623">		buf.append(&quot;                             Assumes a 10 character eventid: \n&quot;);</span>
<span class="nc" id="L624">		buf.append(&quot;                                 assigns first 2 characters as 'eventsource',\n&quot;);</span>
<span class="nc" id="L625">		buf.append(&quot;                                 rest as 'eventsourcecode'\n&quot;);</span>
<span class="nc" id="L626">		buf.append(&quot;[--version=VERSION]      Internal product version.\n&quot;);</span>
<span class="nc" id="L627">		buf.append(&quot;                             Same as --property-version=VERSION\n&quot;);</span>
<span class="nc" id="L628">		buf.append(&quot;\n&quot;);</span>

<span class="nc" id="L630">		buf.append(&quot;[--trackerURL=URL]       tracker url\n&quot;);</span>
<span class="nc" id="L631">		buf.append(&quot;                         Override a configured default trackerURL\n&quot;);</span>
<span class="nc" id="L632">		buf.append(&quot;[--privateKey=FILE]      OpenSSH DSA private key used to sign products\n&quot;);</span>
<span class="nc" id="L633">		buf.append(&quot;                         A product signature may or may not be optional\n&quot;);</span>
<span class="nc" id="L634">		buf.append(&quot;[--signatureVersion=v1]  signature version\n&quot;);</span>
<span class="nc" id="L635">		buf.append(&quot;                         valid values are 'v1' or 'v2'\n&quot;);</span>
<span class="nc" id="L636">		buf.append(&quot;\n&quot;);</span>

<span class="nc" id="L638">		buf.append(&quot;Where product is sent\n&quot;);</span>
<span class="nc" id="L639">		buf.append(&quot;[--connectTimeout=15000] Connect timeout in milliseconds\n&quot;);</span>
<span class="nc" id="L640">		buf.append(&quot;                         Only used with --servers argument\n&quot;);</span>
<span class="nc" id="L641">		buf.append(&quot;                         Must appear before --servers argument.\n&quot;);</span>
<span class="nc" id="L642">		buf.append(&quot;[--binaryFormat]         Send to hub using binary format.\n&quot;);</span>
<span class="nc" id="L643">		buf.append(&quot;                         Only used with --servers argument\n&quot;);</span>
<span class="nc" id="L644">		buf.append(&quot;                         Must appear before --servers argument.\n&quot;);</span>
<span class="nc" id="L645">		buf.append(&quot;[--disableDeflate]       Send to hub without using deflate compression.\n&quot;);</span>
<span class="nc" id="L646">		buf.append(&quot;                         Only used with --servers argument\n&quot;);</span>
<span class="nc" id="L647">		buf.append(&quot;                         Must appear before --servers argument.\n&quot;);</span>
<span class="nc" id="L648">		buf.append(&quot;[--disableParallelSend]  Send to servers sequentially.\n&quot;);</span>
<span class="nc" id="L649">		buf.append(&quot;[--parallelSendTimeout=300]\n&quot;);</span>
<span class="nc" id="L650">		buf.append(&quot;                         timeout for parallel send in seconds.\n&quot;);</span>
<span class="nc" id="L651">		buf.append(&quot;[--servers=SERVERLIST]   server:port[,server:port]\n&quot;);</span>
<span class="nc" id="L652">		buf.append(&quot;                         Overrides any configured senders\n&quot;);</span>
<span class="nc" id="L653">		buf.append(&quot;                         Example: pdldevel.cr.usgs.gov:11235\n&quot;);</span>
<span class="nc" id="L654">		buf.append(&quot;\n&quot;);</span>

<span class="nc" id="L656">		return buf.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>