<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BinaryProductHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.product.io</a> &gt; <span class="el_source">BinaryProductHandler.java</span></div><h1>BinaryProductHandler.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.product.io;

import gov.usgs.earthquake.product.ByteContent;
import gov.usgs.earthquake.product.Content;
import gov.usgs.earthquake.product.ProductId;
import gov.usgs.util.StreamUtils;
import gov.usgs.util.CryptoUtils.Version;

import java.io.InputStream;
import java.io.OutputStream;
import java.net.URI;
import java.net.URL;

/**
 * Generator of binary format for product data.
 *
 * Binary representation of data types:
 * &lt;dl&gt;
 * &lt;dt&gt;Integer&lt;/dt&gt;
 * &lt;dd&gt;4-bytes&lt;/dd&gt;
 * &lt;dt&gt;Long&lt;/dt&gt;
 * &lt;dd&gt;8-bytes&lt;/dd&gt;
 * &lt;dt&gt;Date&lt;/dt&gt;
 * &lt;dd&gt;Long (Date.getTime())&lt;/dd&gt;
 * &lt;dt&gt;byte[]&lt;/dt&gt;
 * &lt;dd&gt;Integer length, raw bytes&lt;/dd&gt;
 * &lt;dt&gt;String&lt;/dt&gt;
 * &lt;dd&gt;byte[] (String.getBytes(StandardCharsets.UTF_8))&lt;/dd&gt;
 * &lt;dt&gt;URL/URI&lt;/dt&gt;
 * &lt;dd&gt;String (URL.toString())&lt;/dd&gt;
 * &lt;/dl&gt;
 *
 *
 * Product is stored in this order:
 *
 * &lt;ol&gt;
 *
 * &lt;li&gt;Header, exactly 1
 * &lt;ol&gt;
 * &lt;li&gt;&quot;BEGINPRODUCT&quot; (string)&lt;/li&gt;
 * &lt;li&gt;ProductId (String)&lt;/li&gt;
 * &lt;li&gt;Status (String)&lt;/li&gt;
 * &lt;li&gt;TrackerURL (URL)&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 *
 * &lt;li&gt;Properties, 0 to many:
 * &lt;ol&gt;
 * &lt;li&gt;&quot;PROPERTY&quot; (String)&lt;/li&gt;
 * &lt;li&gt;name (String)&lt;/li&gt;
 * &lt;li&gt;value (String)&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 *
 * &lt;li&gt;Links, 0 to many:
 * &lt;ol&gt;
 * &lt;li&gt;&quot;LINK&quot; (String)&lt;/li&gt;
 * &lt;li&gt;relation (String)&lt;/li&gt;
 * &lt;li&gt;href (URI)&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 *
 * &lt;li&gt;Contents, 0 to many:
 * &lt;ol&gt;
 * &lt;li&gt;&quot;CONTENT&quot; (String)&lt;/li&gt;
 * &lt;li&gt;path (String)&lt;/li&gt;
 * &lt;li&gt;contentType (String)&lt;/li&gt;
 * &lt;li&gt;lastModified (Date)&lt;/li&gt;
 * &lt;li&gt;length (Long)&lt;/li&gt;
 * &lt;li&gt;raw bytes&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 *
 * &lt;li&gt;Signature Version, 0 or 1.
 * &lt;em&gt;Note, only sent when version != SIGNATURE_V1 for backward compatibility&lt;/em&gt;
 * &lt;ol&gt;
 * &lt;li&gt;&quot;SIGNATUREVERSION&quot; (String)&lt;/li&gt;
 * &lt;li&gt;version (String)&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 *
 * &lt;li&gt;Signature, 0 or 1:
 * &lt;ol&gt;
 * &lt;li&gt;&quot;SIGNATURE&quot; (String)&lt;/li&gt;
 * &lt;li&gt;signature (String)&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 *
 * &lt;li&gt;Footer, exactly 1:
 * &lt;ol&gt;
 * &lt;li&gt;&quot;ENDPRODUCT&quot; (String)&lt;/li&gt;
 * &lt;/ol&gt;
 * &lt;/li&gt;
 *
 * &lt;/ol&gt;
 */
public class BinaryProductHandler implements ProductHandler {

	/** HEADER - BEGINPRODUCT */
	public static final String HEADER = &quot;BEGINPRODUCT&quot;;
	/** PROPERTY */
	public static final String PROPERTY = &quot;PROPERTY&quot;;
	/** LINK */
	public static final String LINK = &quot;LINK&quot;;
	/** CONTENT */
	public static final String CONTENT = &quot;CONTENT&quot;;
	/** SIGNATURE VERSION */
	public static final String SIGNATUREVERSION = &quot;SIGNATUREVERSION&quot;;
	/** SIGNATURE */
	public static final String SIGNATURE = &quot;SIGNATURE&quot;;
	/** ENDPRODUCT */
	public static final String FOOTER = &quot;ENDPRODUCT&quot;;

	private OutputStream out;
	private BinaryIO io;

	/**
	 * Constructor. Sets up a new BinaryIO
	 * @param out an OutputStream
	 */
<span class="fc" id="L121">	public BinaryProductHandler(final OutputStream out) {</span>
<span class="fc" id="L122">		this.out = out;</span>
<span class="fc" id="L123">		this.io = new BinaryIO();</span>
<span class="fc" id="L124">	}</span>

	@Override
	public void onBeginProduct(ProductId id, String status, URL trackerURL)
			throws Exception {
<span class="fc" id="L129">		io.writeString(HEADER, out);</span>
<span class="fc" id="L130">		io.writeString(id.toString(), out);</span>
<span class="fc" id="L131">		io.writeString(status, out);</span>
		// allow trackerURL to be null
<span class="fc bfc" id="L133" title="All 2 branches covered.">		if (trackerURL == null) {</span>
<span class="fc" id="L134">			io.writeString(&quot;null&quot;, out);</span>
		} else {
<span class="fc" id="L136">			io.writeString(trackerURL.toString(), out);</span>
		}
<span class="fc" id="L138">	}</span>

	@Override
	public void onProperty(ProductId id, String name, String value)
			throws Exception {
<span class="fc" id="L143">		io.writeString(PROPERTY, out);</span>
<span class="fc" id="L144">		io.writeString(name, out);</span>
<span class="fc" id="L145">		io.writeString(value, out);</span>
<span class="fc" id="L146">	}</span>

	@Override
	public void onLink(ProductId id, String relation, URI href)
			throws Exception {
<span class="fc" id="L151">		io.writeString(LINK, out);</span>
<span class="fc" id="L152">		io.writeString(relation, out);</span>
<span class="fc" id="L153">		io.writeString(href.toString(), out);</span>
<span class="fc" id="L154">	}</span>

	@Override
	public void onContent(ProductId id, String path, Content content)
			throws Exception {
<span class="pc bpc" id="L159" title="2 of 4 branches missed.">		if (content.getLength() == null || content.getLength() &lt; 0) {</span>
			// binary io only handles streams with length, convert to content
			// with length
<span class="nc" id="L162">			content = new ByteContent(content);</span>
		}

<span class="fc" id="L165">		io.writeString(CONTENT, out);</span>
<span class="fc" id="L166">		io.writeString(path, out);</span>

<span class="fc" id="L168">		io.writeString(content.getContentType(), out);</span>
<span class="fc" id="L169">		io.writeDate(content.getLastModified(), out);</span>
<span class="fc" id="L170">		InputStream contentInputStream = content.getInputStream();</span>
		try {
<span class="fc" id="L172">			io.writeStream(content.getLength().longValue(), contentInputStream, out);</span>
		} finally {
<span class="fc" id="L174">			StreamUtils.closeStream(contentInputStream);</span>
		}
<span class="fc" id="L176">	}</span>

	@Override
	public void onSignatureVersion(ProductId id, Version version) throws Exception {
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">		if (version != Version.SIGNATURE_V1) {</span>
<span class="nc" id="L181">			io.writeString(SIGNATUREVERSION, out);</span>
<span class="nc" id="L182">			io.writeString(version.toString(), out);</span>
		}
<span class="fc" id="L184">	}</span>

	@Override
	public void onSignature(ProductId id, String signature) throws Exception {
		// allow signature to be null
<span class="fc bfc" id="L189" title="All 2 branches covered.">		if (signature == null) {</span>
<span class="fc" id="L190">			return;</span>
		}

<span class="fc" id="L193">		io.writeString(SIGNATURE, out);</span>
<span class="fc" id="L194">		io.writeString(signature, out);</span>
<span class="fc" id="L195">	}</span>

	@Override
	public void onEndProduct(ProductId id) throws Exception {
<span class="fc" id="L199">		io.writeString(FOOTER, out);</span>

<span class="fc" id="L201">		out.flush();</span>
<span class="fc" id="L202">		out.close();</span>
<span class="fc" id="L203">	}</span>

	/**
	 * Free any resources associated with this source.
	 */
	@Override
	public void close() {
<span class="nc" id="L210">		StreamUtils.closeStream(out);</span>
<span class="nc" id="L211">		out = null;</span>
<span class="nc" id="L212">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>