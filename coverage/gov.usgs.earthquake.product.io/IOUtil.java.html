<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IOUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.product.io</a> &gt; <span class="el_source">IOUtil.java</span></div><h1>IOUtil.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.product.io;

import gov.usgs.util.StreamUtils;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.zip.InflaterInputStream;
import java.util.zip.ZipException;

/**
 * Class with main method for converting from one product format to another.
 */
<span class="nc" id="L15">public class IOUtil {</span>

	/** Argument for input file */
	public static final String INFILE_ARGUMENT = &quot;--infile=&quot;;
	/** Argument for input format */
	public static final String INFORMAT_ARGUMENT = &quot;--informat=&quot;;

	/** Argument for output file */
	public static final String OUTFILE_ARGUMENT = &quot;--outfile=&quot;;
	/** Argument for output format */
	public static final String OUTFORMAT_ARGUMENT = &quot;--outformat=&quot;;

	/** Zip format */
	public static final String ZIP_FORMAT = &quot;zip&quot;;
	/** XML format */
	public static final String XML_FORMAT = &quot;xml&quot;;
	/** Directory format */
	public static final String DIRECTORY_FORMAT = &quot;directory&quot;;
	/** Binary format */
	public static final String BINARY_FORMAT = &quot;binary&quot;;

	/**
	 * Returns a ProductHandler based on the output format
	 * @param outformat Output format
	 * @param outfile Output file
	 * @return a Product Handler
	 * @throws IOException if IO error occurs
	 */
	public static ProductHandler getProductHandler(final String outformat,
			final File outfile) throws IOException {
<span class="nc" id="L45">		ProductHandler out = null;</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">		if (outformat.equals(XML_FORMAT)) {</span>
<span class="nc" id="L47">			out = new XmlProductHandler(StreamUtils.getOutputStream(outfile));</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">		} else if (outformat.equals(ZIP_FORMAT)) {</span>
<span class="nc" id="L49">			out = new ZipProductHandler(StreamUtils.getOutputStream(outfile));</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">		} else if (outformat.equals(DIRECTORY_FORMAT)) {</span>
<span class="nc" id="L51">			out = new DirectoryProductHandler(outfile);</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">		} else if (outformat.equals(BINARY_FORMAT)) {</span>
<span class="nc" id="L53">			out = new BinaryProductHandler(StreamUtils.getOutputStream(outfile));</span>
		} else {
<span class="nc" id="L55">			throw new IllegalArgumentException(&quot;unknown product format '&quot;</span>
					+ outformat + &quot;'&quot;);
		}
<span class="nc" id="L58">		return out;</span>
	}

	/**
	 * Returns a product source based on input format
	 * @param informat input file format
	 * @param infile input file
	 * @return a Productsource
	 * @throws IllegalArgumentException if informat argument error
	 * @throws IOException if error occurs
	 */
	public static ProductSource getProductSource(final String informat,
			final File infile) throws IllegalArgumentException, IOException {
<span class="nc" id="L71">		ProductSource in = null;</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (informat.equals(XML_FORMAT)) {</span>
<span class="nc" id="L73">			in = new XmlProductSource(StreamUtils.getInputStream(infile));</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">		} else if (informat.equals(ZIP_FORMAT)) {</span>
<span class="nc" id="L75">			in = new ZipProductSource(infile);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">		} else if (informat.equals(DIRECTORY_FORMAT)) {</span>
<span class="nc" id="L77">			in = new DirectoryProductSource(infile);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">		} else if (informat.equals(BINARY_FORMAT)) {</span>
<span class="nc" id="L79">			in = new BinaryProductSource(StreamUtils.getInputStream(infile));</span>
		} else {
<span class="nc" id="L81">			throw new IllegalArgumentException(&quot;unknown product format '&quot;</span>
					+ informat + &quot;'&quot;);
		}
<span class="nc" id="L84">		return in;</span>
	}

	/**
	 * Auto detect an Xml or Binary product source, that is optionally deflated.
	 *
	 * @param in
	 *            input stream containing optionally deflated xml or binary
	 *            product stream.
	 * @return ProductSource object.
	 * @throws IOException
	 *             if neither binary or xml product source is in stream.
	 */
	public static ProductSource autoDetectProductSource(final InputStream in)
			throws IOException {
<span class="fc" id="L99">		BufferedInputStream bufferedIn = autoDetectDeflate(in);</span>
<span class="fc" id="L100">		int ch = -1;</span>

<span class="fc" id="L102">		bufferedIn.mark(1024);</span>
		// peek at first character in stream
<span class="fc" id="L104">		ch = bufferedIn.read();</span>
<span class="fc" id="L105">		bufferedIn.reset();</span>

<span class="fc" id="L107">		ProductSource productSource = null;</span>
		// determine product format based on first character in stream
<span class="fc bfc" id="L109" title="All 2 branches covered.">		if (((char) ch) == '&lt;') {</span>
			// xml format
<span class="fc" id="L111">			productSource = new XmlProductSource(bufferedIn);</span>
		} else {
			// binary format
<span class="fc" id="L114">			productSource = new BinaryProductSource(bufferedIn);</span>
		}

<span class="fc" id="L117">		return productSource;</span>
	}

	/**
	 * Auto detect an optionally deflated stream.
	 *
	 * @param in
	 *            input stream containing optionally deflated xml or binary
	 *            product stream.
	 * @return ProductSource object.
	 * @throws IOException
	 *             if neither binary or xml product source is in stream.
	 */
	public static BufferedInputStream autoDetectDeflate(final InputStream in)
			throws IOException {
		// stream used to read product
<span class="fc" id="L133">		BufferedInputStream bufferedIn = new BufferedInputStream(in);</span>

		// detect whether incoming stream is compressed
<span class="fc" id="L136">		bufferedIn.mark(1024);</span>
		try {
<span class="fc" id="L138">			InflaterInputStream iis = new InflaterInputStream(bufferedIn);</span>
<span class="fc" id="L139">			iis.read();</span>
			// must be a deflated stream, reset for reading
<span class="fc" id="L141">			bufferedIn.reset();</span>
<span class="fc" id="L142">			bufferedIn = new BufferedInputStream(new InflaterInputStream(bufferedIn));</span>
<span class="fc" id="L143">		} catch (ZipException ze) {</span>
			// not a deflated stream
<span class="fc" id="L145">			bufferedIn.reset();</span>
<span class="fc" id="L146">		}</span>

<span class="fc" id="L148">		return bufferedIn;</span>
	}

	/**
	 * Access into IOUtil
	 * Takes arguments, gets product source and handler
	 * Streams source to handler
	 * @param args CLI args for infile, informat, outfile, outformat
	 * @throws Exception if error occurs
	 */
	public static void main(final String[] args) throws Exception {
<span class="nc" id="L159">		File infile = null;</span>
<span class="nc" id="L160">		File outfile = null;</span>
<span class="nc" id="L161">		String informat = null;</span>
<span class="nc" id="L162">		String outformat = null;</span>

		// parse arguments
<span class="nc bnc" id="L165" title="All 2 branches missed.">		for (String arg : args) {</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if (arg.startsWith(INFILE_ARGUMENT)) {</span>
<span class="nc" id="L167">				infile = new File(arg.replace(INFILE_ARGUMENT, &quot;&quot;));</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">			} else if (arg.startsWith(OUTFILE_ARGUMENT)) {</span>
<span class="nc" id="L169">				outfile = new File(arg.replace(OUTFILE_ARGUMENT, &quot;&quot;));</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">			} else if (arg.startsWith(INFORMAT_ARGUMENT)) {</span>
<span class="nc" id="L171">				informat = arg.replace(INFORMAT_ARGUMENT, &quot;&quot;);</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">			} else if (arg.startsWith(OUTFORMAT_ARGUMENT)) {</span>
<span class="nc" id="L173">				outformat = arg.replace(OUTFORMAT_ARGUMENT, &quot;&quot;);</span>
			}
		}

<span class="nc bnc" id="L177" title="All 4 branches missed.">		if (infile == null || informat == null) {</span>
<span class="nc" id="L178">			printUsage();</span>
<span class="nc" id="L179">			System.exit(1);</span>
		}

<span class="nc bnc" id="L182" title="All 4 branches missed.">		if (outfile == null || outformat == null) {</span>
<span class="nc" id="L183">			printUsage();</span>
<span class="nc" id="L184">			System.exit(1);</span>
		}

<span class="nc" id="L187">		ProductSource in = getProductSource(informat, infile);</span>
<span class="nc" id="L188">		ProductHandler out = getProductHandler(outformat, outfile);</span>
<span class="nc" id="L189">		in.streamTo(out);</span>
<span class="nc" id="L190">	}</span>

	/** CLI usage */
	public static void printUsage() {
<span class="nc" id="L194">		System.err</span>
<span class="nc" id="L195">				.println(&quot;IOUtil --infile=FILE --informat=(xml|directory|zip|binary) --outfile=FILE --outformat=(xml|directory|zip|binary)&quot;);</span>
<span class="nc" id="L196">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>