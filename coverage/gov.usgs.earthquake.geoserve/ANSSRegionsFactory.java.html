<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ANSSRegionsFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pdl</a> &gt; <a href="index.source.html" class="el_package">gov.usgs.earthquake.geoserve</a> &gt; <span class="el_source">ANSSRegionsFactory.java</span></div><h1>ANSSRegionsFactory.java</h1><pre class="source lang-java linenums">package gov.usgs.earthquake.geoserve;

import java.io.File;
import java.io.InputStream;
import java.io.IOException;
import java.util.Date;
import java.util.Timer;
import java.util.TimerTask;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.json.Json;
import javax.json.JsonObject;

import gov.usgs.earthquake.qdm.Regions;
import gov.usgs.util.FileUtils;
import gov.usgs.util.StreamUtils;
import gov.usgs.util.XmlUtils;

/**
 * Class to manage ANSS Authoritative Region updates.
 *
 * Simplest usage:
 *     ANSSRegionsFactory.getFactory().getRegions()
 *
 * Regions are not fetched until {@link #startup()}
 * (or {@link #fetchRegions()}) is called.
 */
public class ANSSRegionsFactory {

    /** logging object */
<span class="fc" id="L32">    public static final Logger LOGGER = Logger.getLogger(ANSSRegionsFactory.class.getName());</span>

    /** milliseconds per day */
    public static final long MILLISECONDS_PER_DAY = 86400000L;

    /** path to write regions.json */
    public static final String DEFAULT_REGIONS_JSON = &quot;regions.json&quot;;

    /** global factory object */
    private static ANSSRegionsFactory SINGLETON;


    /** service used to load regions */
    private GeoserveLayersService geoserveLayersService;

    /** path to local regions file */
<span class="fc" id="L48">    private File localRegions = new File(DEFAULT_REGIONS_JSON);</span>

    /** the current regions object */
    private Regions regions;

    /** shutdown hook registered by startup */
    private Thread shutdownHook;

    /** timer used to auto fetch region updates */
<span class="fc" id="L57">    private Timer updateTimer = new Timer();</span>


    /**
     * Use default GeoserveLayersService.
     */
    public ANSSRegionsFactory () {
<span class="fc" id="L64">        this(new GeoserveLayersService());</span>
<span class="fc" id="L65">    }</span>

    /**
     * Use custom GeoserveLayersService.
     * @param geoserveLayersService to use
     */
<span class="fc" id="L71">    public ANSSRegionsFactory (final GeoserveLayersService geoserveLayersService) {</span>
<span class="fc" id="L72">        this.geoserveLayersService = geoserveLayersService;</span>
<span class="fc" id="L73">    }</span>

    /**
     * Get the global ANSSRegionsFactory,
     * creating and starting if needed.
     * @return ANSSRegionsFactory
     */
    public static synchronized ANSSRegionsFactory getFactory() {
<span class="fc" id="L81">        return getFactory(true);</span>
    }

    /**
     * @param startup if Factory should be created and started, if needed
     * @return ANSSRegionsFactory
     */
    public static synchronized ANSSRegionsFactory getFactory(final boolean startup) {
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (SINGLETON == null) {</span>
<span class="fc" id="L90">            SINGLETON = new ANSSRegionsFactory();</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">            if (startup) {</span>
<span class="nc" id="L92">                SINGLETON.startup();</span>
            }
        }
<span class="fc" id="L95">        return SINGLETON;</span>
    }

    /**
     * Set the global ANSSRegionsFactory,
     * shutting down any existing factory if needed.
     * @param factory to set
     */
    public static synchronized void setFactory(final ANSSRegionsFactory factory) {
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (SINGLETON != null) {</span>
<span class="nc" id="L105">            SINGLETON.shutdown();</span>
        }
<span class="nc" id="L107">        SINGLETON = factory;</span>
<span class="nc" id="L108">    }</span>

    /**
     * Download regions from geoserve.
     *
     * Writes out to &quot;regions.json&quot; in current working directory and,
     * if unable to update, reads in local copy.
     */
    public void fetchRegions () {
        try {
            // try loading from geoserve
<span class="fc" id="L119">            this.regions = loadFromGeoserve();</span>
<span class="fc" id="L120">        } catch (Exception e) {</span>
<span class="fc" id="L121">            LOGGER.log(Level.WARNING,</span>
                    &quot;Error fetching ANSS Regions from geoserve&quot;,
                    e);
            try {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                if (this.regions == null) {</span>
                    // fall back to local cache
<span class="fc" id="L127">                    this.regions = loadFromFile();</span>
                }
<span class="fc" id="L129">            } catch (Exception e2) {</span>
<span class="fc" id="L130">                LOGGER.log(Level.WARNING,</span>
                        &quot;Error fetching ANSS Regions from local file&quot;,
                        e);
<span class="fc" id="L133">            }</span>
<span class="fc" id="L134">        }</span>
<span class="fc" id="L135">    }</span>

    /**
     * Read regions from local regions file.
     * @return Regions
     * @throws IOException if error occurs
     */
    protected Regions loadFromFile() throws IOException {
<span class="fc" id="L143">        try (InputStream in = StreamUtils.getInputStream(this.localRegions)) {</span>
<span class="fc" id="L144">            JsonObject json = Json.createReader(in).readObject();</span>
<span class="fc" id="L145">            Regions regions = new RegionsJSON().parseRegions(json);</span>
            // regions loaded
<span class="fc" id="L147">            LOGGER.fine(&quot;Loaded ANSS Authoritative Regions from &quot;</span>
                    + this.localRegions
<span class="fc" id="L149">                    + &quot;, last modified=&quot; + XmlUtils.formatDate(</span>
<span class="fc" id="L150">                            new Date(this.localRegions.lastModified())));</span>
<span class="fc" id="L151">            return regions;</span>
        }
    }

    /**
     * Read regions from geoserve service.
     * @return Regions
     * @throws IOException if error occurs
     */
    protected Regions loadFromGeoserve() throws IOException {
<span class="fc" id="L161">        LOGGER.fine(&quot;Fetching ANSS Authoritative Regions from Geoserve&quot;);</span>
<span class="fc" id="L162">        JsonObject json = this.geoserveLayersService.getLayer(&quot;anss&quot;);</span>
<span class="fc" id="L163">        Regions regions = new RegionsJSON().parseRegions(json);</span>
<span class="fc" id="L164">        LOGGER.finer(&quot;Loaded ANSS Authoritative Regions from Geoserve&quot;);</span>
        try {
<span class="fc" id="L166">            saveToFile(this.localRegions, json);</span>
<span class="nc" id="L167">        } catch (IOException e) {</span>
            // log for now, since saving is value added
<span class="nc" id="L169">            LOGGER.log(Level.INFO, &quot;Error saving local regions&quot;, e);</span>
<span class="fc" id="L170">        }</span>
<span class="fc" id="L171">        return regions;</span>
    }

    /**
     * Store json to local regions file.
     *
     * @param regionsFile to store to
     * @param json json response to store locally.
     * @throws IOException if IO error occurs
     */
    protected void saveToFile(final File regionsFile, final JsonObject json) throws IOException {
<span class="fc" id="L182">        LOGGER.fine(&quot;Storing ANSS Authoritative Regions to &quot; + regionsFile);</span>
        // save regions if needed later
<span class="fc" id="L184">        FileUtils.writeFileThenMove(</span>
<span class="fc" id="L185">                new File(regionsFile.toString() + &quot;.temp&quot;),</span>
                regionsFile,
<span class="fc" id="L187">                json.toString().getBytes());</span>
<span class="fc" id="L188">        LOGGER.finer(&quot;Stored ANSS Regions to &quot; + regionsFile);</span>
<span class="fc" id="L189">    }</span>

    /**
     * Start updating regions.
     */
    public void startup() {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (this.shutdownHook != null) {</span>
            // already started
<span class="fc" id="L197">            return;</span>
        }

        // do initial fetch
<span class="fc" id="L201">        fetchRegions();</span>

        // schedule periodic fetch
<span class="fc" id="L204">        long now = new Date().getTime();</span>
<span class="fc" id="L205">        long nextMidnight = MILLISECONDS_PER_DAY - (now % MILLISECONDS_PER_DAY);</span>
<span class="fc" id="L206">        updateTimer.scheduleAtFixedRate(</span>
<span class="fc" id="L207">                new TimerTask() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L210">                        fetchRegions();</span>
<span class="nc" id="L211">                    }</span>
                },
                // firstt time at midnight
                nextMidnight,
                // once per day
                MILLISECONDS_PER_DAY);

        // register shutdown hook
<span class="fc" id="L219">        this.shutdownHook = new Thread(() -&gt; {</span>
            // stop periodic fetch
<span class="fc" id="L221">            this.updateTimer.cancel();</span>
<span class="fc" id="L222">        });</span>
<span class="fc" id="L223">        Runtime.getRuntime().addShutdownHook(this.shutdownHook);</span>
<span class="fc" id="L224">    }</span>

    /**
     * Stop updating regions.
     */
    public void shutdown() {
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">        if (this.shutdownHook == null) {</span>
            // not started or already stopped
<span class="nc" id="L232">            return;</span>
        }

        // stop periodic fetch
<span class="fc" id="L236">        this.updateTimer.cancel();</span>

        // remove shutdown hook
<span class="fc" id="L239">        Runtime.getRuntime().removeShutdownHook(this.shutdownHook);</span>
<span class="fc" id="L240">        this.shutdownHook = null;</span>
<span class="fc" id="L241">    }</span>

    /**
     * Get the service.
     * @return geoserveLayersService
     */
    public GeoserveLayersService getGeoserveLayersService() {
<span class="nc" id="L248">        return this.geoserveLayersService;</span>
    }

    /**
     * Set the service.
     * @param service GeoserveLayersService to set
     */
    public void setGeoserveLayersService(final GeoserveLayersService service) {
<span class="nc" id="L256">        this.geoserveLayersService = service;</span>
<span class="nc" id="L257">    }</span>

    /**
     * Get the local regions file.
     * @return localRegions
     */
    public File getLocalRegions() {
<span class="nc" id="L264">        return this.localRegions;</span>
    }

    /**
     * Set the local regions file.
     * @param localRegions file to set
     */
    public void setLocalRegions(final File localRegions) {
<span class="fc" id="L272">        this.localRegions = localRegions;</span>
<span class="fc" id="L273">    }</span>

    /**
     * Get the most recently fetched Regions.
     * @return regions
     */
    public Regions getRegions () {
<span class="fc" id="L280">        return this.regions;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>